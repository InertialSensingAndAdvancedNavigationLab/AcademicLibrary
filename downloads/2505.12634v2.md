1


## **MSCEKF-MIO: Magnetic-Inertial Odometry** **Based on Multi-State Constraint Extended** **Kalman Filter**

Jiazhu Li, Jian Kuang, Xiaoji Niu



_**Abstract**_ **—To overcome the limitations of existing indoor odom-**
**etry technologies—which often cannot simultaneously meet re-**
**quirements for accuracy, cost-effectiveness, and robustness—this**
**paper proposes a novel magnetometer array–aided inertial**
**odometry approach, MSCEKF-MIO (Multi-State Constraint Ex-**
**tended Kalman Filter–based Magnetic-Inertial Odometry). We**
**construct a magnetic field model by fitting measurements from**
**the magnetometer array and then use temporal variations in**
**this model—extracted from continuous observations—to estimate**
**the carrier’s absolute velocity. Furthermore, we implement the**
**MSCEKF framework to fuse observed magnetic field varia-**
**tions with position and attitude estimates from inertial navi-**
**gation system (INS) integration, thereby enabling autonomous,**
**high-precision indoor relative positioning. Experimental results**
**demonstrate that the proposed algorithm achieves superior ve-**
**locity estimation accuracy and horizontal positioning precision**
**relative to state-of-the-art magnetic array–aided INS algorithms**
**(MAINS). On datasets with trajectory lengths of 150–250 m, the**
**proposed method yields an average horizontal position RMSE of**
**approximately 2.5 m. In areas with distinctive magnetic features,**
**the magneto-inertial odometry achieves a velocity estimation**
**accuracy of 0.07 m/s. Consequently, the proposed method offers a**
**novel positioning solution characterized by low power consump-**
**tion, cost-effectiveness, and high reliability in complex indoor**
**environments.**


_**Index Terms**_ **—Indoor positioning, Magnetic field-based local-**
**ization, Odometry, Magnetometer array, MEMS-IMU, MSCEKF.**


I. I NTRODUCTION
# T HE indoor positioning market is projected to grow fromUSD 11.9 billion in 2024 to USD 31.4 billion by 2029,

registering a compound annual growth rate (CAGR) of 21.4 %
(MarketsandMarkets, 2024). This growth is mainly driven by
the increasing demand for location-based services (LBS) in
smart retail, industrial IoT (IIoT), and emergency response
applications. Indoor environments, as quintessential scenarios
for LBS, have spurred a wide array of positioning technologies. Infrastructure-dependent technologies such as pseudolites, Bluetooth, and Wi-Fi incur high implementation costs
and face scalability challenges in large-scale deployments.
Vision-based localization systems suffer from environmental
sensitivity and high power consumption, which fundamentally
limits their practical applicability. Magnetic field fingerprinting
relies on constructing and maintaining extensive fingerprint
databases, resulting in substantial deployment costs. In contrast, inertial navigation system (INS)–based dead reckoning



(DR) has emerged as a self-contained indoor positioning
approach, offering autonomous operation and resilience to
external signal interference.
Consumer-grade devices predominantly employ low-cost
MEMS-IMUs (micro-electromechanical systems inertial measurement units), which exhibit limited inherent accuracy and
rapid error accumulation when using conventional strapdown
navigation algorithms. Therefore, obtaining high-precision,
robustness-enhanced odometry is essential to constrain error growth and improve the usability and reliability of
MEMS-IMU–based dead reckoning (DR).
Existing odometry approaches include inertial, wheel, visual, and LiDAR-based methods [1]. Each modality risks
degraded performance under certain operational conditions.
Inertial odometry suffers from positioning drift caused by
sensor bias accumulation and noise, leading to progressive
error growth; wheel odometry is vulnerable to wheel slippage and terrain irregularities, which introduce non-holonomic
constraint violations in motion estimation; visual odometry is highly sensitive to illumination changes and dynamic
occlusions, often failing in low-texture environments; and
LiDAR odometry is costly, computationally intensive, and
degrades in environments with weak geometric features.
No existing odometry method achieves optimal precision,
cost-effectiveness, and robustness simultaneously. Magnetic
field odometry offers a lightweight means of measuring velocity. It operates without pre-established magnetic maps,
instead leveraging a magnetometer array to provide odometric
data—including position and velocity [2].
Due to ferromagnetic interference, indoor magnetic fields
exhibit long-term stability and spatial distinctiveness, making
them a reliable positioning source. In 2007, Vissi`ere et al.
pioneered the use of indoor magnetic field disturbances to improve IMU-based position and velocity estimation [3]. Vissi`ere
et al. derived equations relating magnetic field gradients to
user velocity and employed a distributed magnetometer array
for velocity estimation. Subsequent studies expanded on this
work. In 2011, Dorveaux et al. addressed moving rigid-body
localization by integrating magnetic disturbances with IMU
measurements, establishing the Magnetic-Inertial Navigation
(MINAV) framework [4]. In 2016, Chesneau et al. integrated
inertial sensor and multi-magnetometer measurements, developing an Extended Kalman Filter (EKF) for data fusion [5].
Zmitri and Makia derived higher-order differential equations
of magnetic fields to mitigate noise in gradient measurements,
using a distributed magnetometer array to monitor both fields


and their spatial derivatives [6]. Recent studies have applied
a polynomial model to characterize local magnetic fields [7].
Further analysis of this model-based methodology is presented
in [8]. They augmented the magnetic field model parameters
into the INS error-state vector to facilitate Kalman filter
prediction and update processes. Detailed derivations and analyses were subsequently documented in [2], accompanied by
real-world data collection to evaluate algorithm performance.
The corresponding experimental datasets and implementation
code were also made publicly available.
Recently, a dual-magnetometer velocity estimation algorithm was implemented for robotic speed determination [9], employing waveform matching between paired
vehicle-mounted magnetometers to compute forward velocity. Experimental results indicate that the approach in [9]
matches wheel odometry performance in magnetically rich
environments. Building on this concept, [10] deployed a
dual-magnetometer velocity measurement system on pedestrian helmets and incorporated postural changes into the waveform similarity analysis. However, these methods are restricted
to pedestrian forward velocity estimation and exhibit sensitivity to the baseline distance between magnetometers. This paper
presents a magnetometer-array–aided inertial odometry (MIO)
framework grounded in the Multi-State Constraint Extended
Kalman Filter (MSCEKF). Compared with the method in [2],
the proposed approach achieves superior horizontal velocity
and position estimation accuracy and offers improved stability
in positioning results.
This work makes the following contributions. First, we
derive local magnetic field model equations based on the
fundamental assumption that magnetic fields in charge-free
environments exhibit zero divergence and curl. Second, we
formulate an error propagation model linking the magnetic
field model to relative pose estimation. Third, we incorporate
the Multi-State Constraint Extended Kalman Filter (MSCEKF)
in the data fusion phase to enhance robustness. In experiments,
we compare the proposed algorithm against MAINS [2], a
state-of-the-art open-source solution. We collected comprehensive field measurements using a custom-built platform to
rigorously evaluate the proposed methodology.
The remainder of this paper is structured as follows. Section II derives the local magnetic field model. Section III details the filtering algorithm for data fusion. Section IV analyzes
algorithm performance using both open-source and proprietary
datasets, and examines the impact of varying magnetic gradient intensities. Finally, Section V concludes the paper and
proposes directions for future work.


II. L OCAL M AGNETIC F IELD M ODELING


The magnetic field is a three-dimensional vector field
whose characteristics are governed by Maxwell’s equations.
The magnetic field model is denoted by _**M**_ ( _**r**_ _,_ _**µ**_ ), where
_**r**_ = [ _r_ _x_ _, r_ _y_ _, r_ _z_ ] _[⊤]_ or _**r**_ = [ _x, y, z_ ] _[⊤]_, represents the position
vector from the origin of the local magnetic field model to any
arbitrary point in space. The coefficients _**µ**_ of the magnetic
field polynomial model have a size (number of elements)
determined by the polynomial’s order. Under the conditions of



2


free space charge and external magnetic interference sources
located beyond a 1-meter range, the magnetic field model must
satisfy the curl-free and divergence-free assumptions:


_∇_ _**r**_ _×_ _**M**_ ( _**r**_ _,_ _**µ**_ ) = 0 (1)


_∇_ _**r**_ _·_ _**M**_ ( _**r**_ _,_ _**µ**_ ) = 0 (2)


Given the curl-free nature of the magnetic field, there necessarily exists a scalar potential function _**ϕ**_ ( _**r**_ _,_ _**µ**_ ) satisfying:


_**M**_ ( _**r**_ _,_ _**µ**_ ) = _∇_ _**r**_ _**ϕ**_ ( _**r**_ _,_ _**µ**_ ) (3)


In the equation, _**ϕ**_ ( _**r**_ _,_ _**µ**_ ) represents an ( _l_ + 1)th order polynomial function of _**r**_, where _l ∈_ N. For the case _l_ = 1, the scalar
potential function can be expressed as:


_**ϕ**_ ( _**r**_ _,_ _**µ**_ ) = _h_ ( _**r**_ ) _[⊤]_ _**µ**_ + _c_ (4)


_h_ ( _**r**_ ) _[⊤]_ = � _x_ _y_ _z_ _xy_ _xz_ _yz_ _x_ [2] _y_ [2] _z_ [2] [ �] (5)


_⊤_
_**µ**_ = � _µ_ 1 _. . ._ _µ_ 9 � (6)


In the equation, _c_ denotes a constant term, while _**µ**_ represents
the local magnetic field model parameters.
Let **Γ** ( _**r**_ ) = _∇_ _**r**_ _h_ ( _**r**_ ) _[⊤]_, combining equation (3) and (4)
yields:
_**M**_ ( _**r**_ _,_ _**µ**_ ) = _∇_ _**r**_ _**ϕ**_ ( _**r**_ _,_ _**µ**_ ) = **Γ** ( _**r**_ ) _**µ**_ (7)


where **Γ** is defined as:





(8)




**Γ** ( _**r**_ ) =



1 0 0 _y_ _z_ 0 2 _x_ 0 0

 0 1 0 _x_ 0 _z_ 0 2 _y_ 0

 0 0 1 0 _x_ _y_ 0 0 2 _z_



Combining with the divergence-free assumption of the local
magnetic field in (2):


_∇_ _**r**_ _·_ **Γ** ( _**r**_ ) _**µ**_ = 0 (9)







= 0 (10)




_∇_ _**r**_ _·_







_µ_ 1 + _µ_ 4 _y_ + _µ_ 5 _z_ + 2 _µ_ 7 _x_

 _µ_ 2 + _µ_ 4 _x_ + _µ_ 6 _z_ + 2 _µ_ 8 _y_

 _µ_ 3 + _µ_ 5 _x_ + _µ_ 6 _y_ + 2 _µ_ 9 _z_



By reorganizing equation (10):


_µ_ 7 + _µ_ 8 + _µ_ 9 = 0 (11)


Let _µ_ 9 = _−_ ( _µ_ 7 + _µ_ 8 ), then the equation can be rewritten as:


_**M**_ ( _**r**_ _,_ _**θ**_ ) = **Φ** ( _**r**_ ) _**θ**_ (12)


Equation (12) represents the derived local magnetic field
model. Here, _**θ**_ denotes the polynomial coefficients whose
dimensionality relates to the model order _l_ through _dim_ ( _**θ**_ ) =
_l_ [2] +4 _l_ +3. **Φ** is the coefficient matrix. For a 1st-order magnetic
field model ( _l_ = 1), **Φ** can be expressed as:





(13)




**Φ** ( _**r**_ ) =



1 0 0 _y_ _z_ 0 2 _x_ 0

0 1 0 _x_ 0 _z_ 0 2 _y_

0 0 1 0 _x_ _y_ _−_ 2 _z_ _−_ 2 _z_



The local magnetic field model equation shown in Equation
(12) is applicable to any coordinate system.
The relationship between magnetic field vectors at the identical spatial location between two consecutive time instants is


x


**IMU**

|y<br>y<br>y<br>x<br>magnetic field v<br>x|Col2|
|---|---|
|||
|||
|||



Fig. 1. A 2D illustration of the geometric relationship between the body
frames at two consecutive times.


investigated. The magnetic field vectors in the body frame (bframe) at two consecutive time instants satisfy the following
relationship:


_**M**_ _[b]_ _[j]_ ( _**r**_ _[b]_ _[j]_ _,_ _**θ**_ _j_ ) = _**C**_ _[b]_ _b_ _[j]_ _i_ _**[M]**_ _[ b]_ _[i]_ [(] _**[r]**_ _[b]_ _[i]_ _[,]_ _**[ θ]**_ _[i]_ [)] (14)


**Φ** ( _**r**_ _[b]_ _[j]_ ) _**θ**_ _j_ = _**C**_ _[b]_ _b_ _[j]_ _i_ **[Φ]** [(] _**[r]**_ _[b]_ _[i]_ [)] _**[θ]**_ _[i]_ (15)


where _b_ _i_ and _b_ _j_ denote the body frame at the current and
previous time instants, respectively. Fig.1 illustrates the geometric relationship between the body frames ( _b_ _i_ and _b_ _j_ ) at two
consecutive time instants.
The parameters _**θ**_ [ˆ] of the magnetic field model can be
estimated via least squares using observations from the magnetometer array and Equation (12).


_**θ**_ ˆ = ( **Φ** _[⊤]_ ( _**l**_ _[b]_ _i_ _[i]_ [)] **[Φ]** [(] _**[l]**_ _[b]_ _i_ _[i]_ [))] _[−]_ [1] **[Φ]** [(] _**[l]**_ _[b]_ _i_ _[i]_ [)] _[⊤]_ _**[M]**_ _[ b]_ _[i]_ (16)


Here _**l**_ _[b]_ _i_ _[i]_ denotes the coordinates of each magnetometer in
the _b_ _i_ -frame, _**M**_ _[b]_ _[i]_ represents the observation vector of each
magnetometer, and **Φ** ( _**l**_ _[b]_ _i_ _[i]_ [)][ is the coefficient matrix constructed]
from the coordinate vector _**l**_ _[b]_ _i_ _[i]_ following Equation(13). The
estimation covariance matrix for the local magnetic field model
parameters _**θ**_ [ˆ] is:


_**Cov**_ _**θ**_ ˆ = _σ_ [2] ( **Φ** _[⊤]_ **Φ** ) _[−]_ [1] (17)


where _σ_ [2] is estimated by calculating the sum of squares of
model residuals.
Subsequently, the local magnetic field parameters _**θ**_ [ˆ] are
utilized to predict the magnetic field observation _**M**_ [ˆ] _bj_ _i_ [at the]
previous time step. We assume that the parameters of the
magnetic field model do not change significantly between two
adjacent moments:


_**M**_ ˆ _bj_ _i_ [=] **[ Φ]** [(] _**[l]**_ _[b]_ _j_ _[i]_ [)ˆ] _**[θ]**_ (18)


where _**l**_ _[b]_ _j_ _[i]_ denotes the coordinates of the magnetometer in
the _b_ _i_ -frame at the previous time. Since the magnetometers
are rigidly mounted on the platform assembly, the coordinate
relationship _**l**_ _[b]_ _j_ _[j]_ [=] _**[ l]**_ _[b]_ _i_ _[i]_ [.]


_**l**_ _[b]_ _j_ _[i]_ [=] _**[ C]**_ _[i]_ _j_ _**[l]**_ _[b]_ _j_ _[j]_ [+ ∆] _**[r]**_ _[b]_ _[i]_ (19)



3


_**C**_ _[i]_ _j_ [=] _**[ C]**_ _[b]_ _n_ _[i]_ _**[C]**_ _[n]_ _b_ _j_ (20)


∆ _**r**_ _[b]_ _[i]_ = _**C**_ _[b]_ _n_ _[i]_ [∆] _**[r]**_ _[n]_ _i_ [=] _**[ C]**_ _[b]_ _n_ _[i]_ [(] _**[r]**_ _[n]_ _j_ _[−]_ _**[r]**_ _[n]_ _i_ [)] (21)


where _**C**_ _[i]_ _j_ [represents the relative rotation between the] _[ b]_ _[i]_ [-frame]
and _b_ _j_ -frame at consecutive time steps, ∆ _**r**_ _[b]_ _[i]_ denotes the
projection of the position variation in the _n_ -frame onto the _b_ _i_ frame. Synthesizing Equations (14), (15), and (18) yields the
predicted magnetic field value _**M**_ ˆ _bj_ _j_ from the previous time
step:


_**M**_ ˆ _bj_ _j_ [=] _**[ C]**_ _[i]_ _j_ _**M**_ [ˆ] _bj_ _i_ [=] _**[ C]**_ _[i]_ _j_ **[Φ]** [(] _**[l]**_ _[b]_ _j_ _[i]_ [)ˆ] _**[θ]**_ (22)


Equation (22) encodes the principle that, within a sufficiently small spatiotemporal neighborhood, the local magnetic
field parameters _**θ**_ remain constant. Within the model’s effective domain, we attribute observed magnetic fluctuations
to changes in the platform’s pose. By collecting magnetic
field observations within this domain, we employ perturbation
analysis to derive relationships between variations in the
magnetic gradient and changes in the platform’s pose. These
relationships yield constraint terms derived from observations,
which we integrate into the filtering framework to improve
state estimation accuracy.


III. M AGNETIC -I NERTIAL O DOMETRY WITH

M AGNETOMETER A RRAY C ONSTRAINT


This section presents an overview of the proposed data
fusion algorithm. Figure 2 presents the algorithm’s flowchart.
First, strap-down inertial navigation mechanization is executed
to determine the vehicle’s current position, velocity, and attitude. Next, magnetic array measurements are used to estimate
the parameters of the local magnetic field model. Subsequently, historical state information is employed to compute
relative pose changes between successive epochs and to predict
the corresponding magnetic field models. These predictions
are then combined with magnetic array measurements from
adjacent epochs to formulate update constraints. Finally, the
Multi-State Constraint Extended Kalman Filter (MSCEKF)
is applied to fuse magnetic field model variations—observed
by the magnetometer array—with relative poses derived from
inertial navigation integration, thereby achieving continuous
and reliable state estimation. Additionally, the algorithm incorporates magnetic vector constraints in the navigation frame
to improve heading angle estimation.


_A. Inertial Navigation Algorithm_


The INS Mechanization algorithm is based on the idea
that the current position, velocity, and attitude of a moving
object can be obtained by integrating acceleration twice and
angular rate once, given the initial navigation state. In this
paper, a low-cost MEMS-IMU is employed for mechanization,
allowing minor corrections (e.g., Earth rotation effects) to


4



State error























Fig. 2. Algorithm flow chart of MSCEKF-MIO


be neglected. The simplified mechanization in the navigation
frame (n-frame) is expressed as follows:



_**r**_ _[n]_ _k−_ 1 [+] _**[ v]**_ _[n]_ _k_ [∆] _[t]_

˜ _b_
_**v**_ _[n]_ _k−_ 1 [+] � _**C**_ _[n]_ _b,k_ � _**f**_ _k_ _[−]_ _**[b]**_ _[a]_ � + _**g**_ _[n]_ [�] ∆ _t_

_**C**_ _[n]_ _b,k−_ 1 [+] _**[ C]**_ _[n]_ _b,k−_ 1 �� _**ω**_ ˜ _[b]_ _k_ _[−]_ _**[b]**_ _[g]_ � _×_ � ∆ _t_









_**r**_ _[n]_ _k_

 _**v**_ _[n]_ _k_

_**C**_ _[n]_
 _b,k_



 =









(23)
where _**r**_ _[n]_ and _**v**_ _[n]_ represent the position vector and the velocity vector in the n-frame respectively, _**C**_ _[n]_ _b_ [represents the]
transformation matrix from the b-frame to the n-frame, _**g**_ _[n]_

represents the Earth gravity vector in the n-frame, _**f**_ [˜] _bk_ [and][ ˜] _**[ω]**_ _[b]_ _k_
represent the acceleration measurement vector and angle rate
measurement in the b-frame, respectively. _**b**_ _a_ and _**b**_ _g_ represent
the bias of the accelerometer and gyroscope, respectively.
∆ _t_ = _t_ _k_ _−_ _t_ _k−_ 1 represents the time interval between the _k_ -th
and ( _k −_ 1)-th epoch.



of the historical states. The discretized and linearized system
error model can be formulated as follows:

_δ_ _**x**_ _k|k−_ 1 = **Φ** _k−_ 1 _δ_ _**x**_ _k−_ 1 _|k−_ 1 + _**w**_ _k_
(25)
� _δ_ _**z**_ _k_ = _**H**_ _k_ _δ_ _**x**_ _k|k−_ 1 + _**n**_ _k_


where the subscripts _k −_ 1 and _k_ represent the epoch,
_δ_ _**x**_ _k−_ 1 _|k−_ 1 and _δ_ _**x**_ _k|k−_ 1 represent the previous and predicted
error state vectors, respectively. _δ_ _**z**_ _k_ represents the measurement misclosure vector, _**H**_ _k_ is the observation matrix, _**w**_ _k_ and
_**n**_ _k_ are the process noise and measurement noise, respectively.
The state transition matrix **Φ** _k_ is expressed as follows:









_**I**_ 33 _**I**_ 33 ∆ _t_ **0** 33 **0** 33 **0** 33
**0** 33 _**I**_ 33 ( _**f**_ _[n]_ _k_ _[×]_ [) ∆] _[t]_ **0** 33 _**C**_ _[n]_ _b,k_ [∆] _[t]_
**0** 33 **0** 33 _**I**_ 33 _−_ _**C**_ _[n]_ _b,k_ [∆] _[t]_ **0** 33
**0** 33 **0** 33 **0** 33 _**I**_ 33 **0** 33
**0** 33 **0** 33 **0** 33 **0** 33 _**I**_ 33



**Φ** _k,_ 15 _×_ 15 =









(26)


(27)
�



_B. Multi State Constraint Extended Kalman Filter_


We utilize the Multi-State Constraint Extended Kalman Fil
ter (MSC-EKF) for data fusion. MSC-EKF is a filtering-based
visual-inertial odometry (VIO) method [11] that maintains a
sliding window of state vectors spanning multiple epochs,
encompassing both current and historical states (e.g., position
and attitude). It leverages constraint relationships between
historical states and current observations during measurement
updates. In the proposed MSC-EKF, we incorporate multiple
historical position states into the state vector. Consequently,
we define the error state vector as follows:


_n_ _⊤_
_δ_ _**x**_ _k_ = � _δ_ _**r**_ _k_ _δ_ _**v**_ _[n]_ _k_ _**ϕ**_ _k_ _δ_ _**b**_ _g,k_ _δ_ _**b**_ _a,k_ _δ_ _**r**_ _[n]_ _k−m_ _· · ·_ _δ_ _**r**_ _[n]_ _k−_ 1 �

(24)
where _δ_ _**r**_ _[n]_, _δ_ _**v**_ _[n]_ and _**ϕ**_ represent the error vectors of position,
velocity, and attitude in the n-frame, respectively. _δ_ _**b**_ _g_ and _δ_ _**b**_ _a_
represent the error vectors for gyroscope and accelerometer
biases, respectively. _k_ denotes the epoch index, _m_ specifies
the number of historical states retained in the sliding window,
and _δ_ _**r**_ _[n]_ _k−m_ [and] _[ δ]_ _**[r]**_ _[n]_ _k−_ 1 [represent the position error vectors]



**Φ** _k_ = � **Φ0** _k,_ 3 _m_ 15 _××_ 1515 _**I**_ **0** 315 _m××_ 33 _mm_



In the MSC-EKF framework, cloned states(augmented historical states) do not require updates during the one-step
prediction phase. After state prediction, the covariance propagation formula is expressed as:


_**P**_ _k,k−_ 1 = **Φ** _k−_ 1 _**P**_ _k−_ 1 **Φ** _[⊤]_ _k−_ 1 [+] _**[ Q]**_ _k_ (28)


where _**P**_ _k−_ 1 denotes the initial state covariance matrix, _**Q**_ _k_ denotes the process noise covariance matrix for state prediction.
When valid observations are acquired, the following formula
can be applied to update the state vector and its associated
covariance matrix:


_δ_ _**x**_ _k_ = _δ_ _**x**_ _k,k−_ 1 + _**K**_ _k_ ( _δ_ _**z**_ _k_ _−_ _**H**_ _k_ _**x**_ _k,k−_ 1 ) (29)


_**P**_ _k_ = ( _**I**_ _−_ _**K**_ _k_ _**H**_ _k_ ) _**P**_ _k,k−_ 1 ( _**I**_ _−_ _**K**_ _k_ _**H**_ _k_ ) _[⊤]_ + _**K**_ _k_ _**R**_ _k_ _**K**_ _[⊤]_ _k_
(30)

_−_ 1
_**K**_ _k_ = _**P**_ _k,k−_ 1 _**H**_ _[⊤]_ _k_ _**H**_ _k_ _**P**_ _k,k−_ 1 _**H**_ _[⊤]_ _k_ [+] _**[ R]**_ _[k]_ (31)
� �


It is noteworthy that after the MSC-EKF completes the state
vector update, a block permutation of the current covariance


matrix _**P**_ _k_ must be performed. This step aims to manage the
_m_ historical cloned states in the sliding window and ensure
structural consistency between the covariance matrix and the
state vector. Taking _m_ = 2 as an example, the specific cloning
strategy for _**P**_ _k_ is as follows:


_**P**_ _[new]_ _k_ = _**H**_ _clone_ _**P**_ _k_ _**H**_ _[⊤]_ _clone_ (32)





 (33)



_**H**_ _clone_ =









_**I**_ 15 _×_ 15 **0** 3 _×_ 3 **0** 3 _×_ 3
**0** 12 _×_ 3 **0** 12 _×_ 3
**0** 3 _×_ 3 **0** 3 _×_ 12 **0** 3 _×_ 3 _**I**_ 3 _×_ 3
_**I**_ 3 _×_ 3 **0** 3 _×_ 12 **0** 3 _×_ 3 **0** 3 _×_ 3



_C. Observation model_


As derived in Section II, this paper has established the
local magnetic field model and its predictive formulation
across adjacent epochs. After performing an error perturbation
analysis on Equation (22), the predicted magnetic field model
can be expressed as:

_**M**_ ˆ _bj_ _j_ [=] _**[ M]**_ _[ b]_ _j_ _[j]_ [+] _**[ C]**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)] _[δ]_ _**[l]**_ _[b]_ _j_ _[i]_ [+ [] _**[M]**_ _[ b]_ _j_ _[i]_ _[×]_ []] _[δ]_ _**[b]**_ _[g]_ _[dt]_



= _**M**_ _[b]_ _j_ _[j]_ [+] _**[ C]**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)] _**[C]**_ _n_ _[b]_ _[i]_ _[δ]_ _**[v]**_ _[n]_ _j_ _[dt]_

+ �[ _**M**_ _[b]_ _j_ _[i]_ _[×]_ []] _[ −]_ _**[C]**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)[] _**[l]**_ _[b]_ _j_ _[j]_ _[×]_ []] � _δ_ _**b**_ _g_ _dt_

_−_ _**C**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)[∆] _**[r]**_ _[b]_ _[i]_ _[×]_ []] _**[ϕ]**_



(34)



where ∆ _t_ denotes the time difference between adjacent
epochs. Taking the first-order magnetic field model as an
example, _**B**_ ( _**θ**_ ) is formulated as:





(35)




_**B**_ ( _**θ**_ ) =



2 _θ_ 4 _θ_ 6 _θ_ 7

 _θ_ 6 2 _θ_ 5 _θ_ 8

 _θ_ 7 _θ_ 8 _−_ 2( _θ_ 4 + _θ_ 5 )



For the magnetic field model from the previous epoch, the
corresponding observations can be obtained via magnetometer
array measurements as follows:

_**M**_ ˜ _bj_ _j_ [=] _**[ M]**_ _[ b]_ _j_ _[j]_ [+] _**[ n]**_ _[v]_ (36)


where _**n**_ _v_ denotes the observation noise. By combining Equations (34) and (36), the following observation equation can be
derived:



_δ_ _**z**_ _mag_ = _**M**_ [ˆ] _bj_ _j_ _[−]_ _**M**_ [˜] _bj_ _j_
= _**C**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)] _**[C]**_ _n_ _[b]_ _[i]_ _[δ]_ _**[v]**_ _[n]_ _j_ _[dt]_

+ �[ _**M**_ _[b]_ _j_ _[i]_ _[×]_ []] _[ −]_ _**[C]**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)[] _**[l]**_ _[b]_ _j_ _[j]_ _[×]_ []] � _δ_ _**b**_ _g_ _dt_

_−_ _**C**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)[∆] _**[r]**_ _[b]_ _[i]_ _[×]_ []] _**[ϕ]**_ [ +] _**[ n]**_ _[v]_



(37)



As derived in the preceding sections, the observation equation (37) utilizing magnetometer array measurements for the
filter’s measurement update has been established. Therefore,
the design matrix can be formulated as:


_**H**_ _mag_ = � **0** 33 _**H**_ 12 _**H**_ 13 _**H**_ 14 **0** 33 **0** 33 _..._ **0** 33 �

(38)
The submatrix in _**H**_ _mag_ is defined as:
 _**H**_ 12 = _**C**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)] _**[C]**_ _n_ _[b]_ _[i]_ _[dt]_

_**H**_ 13 = _−_ _**C**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)[∆] _**[r]**_ _[b]_ _[i]_ _[×]_ []] (39)





_**H**_ 12 = _**C**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)] _**[C]**_ _n_ _[b]_ _[i]_ _[dt]_



_**H**_ 13 = _−_ _**C**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)[∆] _**[r]**_ _[b]_ _[i]_ _[×]_ []]

_**H**_ 14 = _−_ _**C**_ _[j]_ _i_ _**[B]**_ [(] _**[θ]**_ [)[] _**[l]**_ _[b]_ _j_ _[j]_ _[×]_ []] _[dt]_



(39)



5


Since _δ_ _**z**_ _mag_ incorporates both measurement noise and estimation errors in the magnetic field model parameters, the
observation covariance matrix should be composed of two

components:


_⊤_
_**R**_ _meas_ = � _**C**_ _[j]_ _i_ **[Φ]** [(] _**[l]**_ _[b]_ _j_ _[i]_ [)] � _**Cov**_ _**θ**_ ˆ � _**C**_ _[j]_ _i_ **[Φ]** [(] _**[l]**_ _[b]_ _j_ _[i]_ [)] � + diag( _σ_ _mag_ [2] [)]
(40)
Here _σ_ _mag_ [2] [denotes the standard deviation of the magnetometer]
array measurement noise.
Previous studies [12] have shown a mismatch between
estimated state covariance and actual system uncertainty in
EKF-based odometry-aided INS implementations. Likewise,
in magnetometer array–aided INS scenarios, the heading angle becomes unobservable due to the absence of absolute
heading references. However, the EKF’s Jacobian linearization
introduces higher-order truncation errors, resulting in spurious
observability of inherently unobservable states within the
covariance matrix. This effect artificially inflates the filter’s
confidence in heading error estimates, potentially causing filter
divergence.
To address heading unobservability, we introduce a magnetic vector attitude constraint in the navigation frame. This
constraint uses differences between consecutive n-frame magnetic field measurements from a single magnetometer, enabling measurement updates driven by attitude variations. Assuming (1) the n-frame magnetic vector remains constant and
(2) the attitude error is unchanged between adjacent epochs,
the observed n-frame magnetic vector can be expressed as
follows:


ˆ _n_ _n_
_**M**_ _i_ [= ˆ] _**[C]**_ _b_ _**[M]**_ _[ b]_ _i_ [= [] _**[I]**_ _[ −]_ _**[ϕ]**_ _[×]_ []] _**[C]**_ _[n]_ _b_ _**[M]**_ _[ b]_ _i_
ˆ _n_ _n_ (41)
_**M**_ _j_ [= ˆ] _**[C]**_ _b_ _**[M]**_ _[ b]_ _j_ [= [] _**[I]**_ _[ −]_ _**[ϕ]**_ _[×]_ []] _**[C]**_ _[n]_ _b_ _**[M]**_ _[ b]_ _j_


The Kalman filter measurement equation incorporating the
magnetic vector attitude constraint is formulated as:


_n_ _n_
_δ_ _**z**_ = _**M**_ [ˆ] _i_ _[−]_ _**M**_ [ˆ] _j_ [=] �( _**M**_ _[b]_ _i_ _[−]_ _**[M]**_ _[ b]_ _j_ [)] _[×]_ � _**ϕ**_ (42)


where _**M**_ _[b]_ _i_ [denotes the magnetic field vector in the body]
frame at the current epoch; _**M**_ _[b]_ _j_ [denotes the magnetic field]
vector in the b-frame at the previous epoch; _**C**_ _[n]_ _b_ [represents]
the rotation matrix transforming vectors from the b-frame
to the navigation frame. The corresponding design matrix is
expressed as:


_**H**_ _att_ = � **0** 33 **0** 33 �( _**M**_ _[b]_ _i_ _[−]_ _**[M]**_ _[ b]_ _j_ [)] _[×]_ � **0** 33 _..._ **0** 33 � (43)


IV. E XPERIMENTAL R ESULTS


_A. Results on OA dataset_


To validate the performance of the proposed MSCEKF-MIO
algorithm, this section conducts a comparative analysis with
the state-of-the-art open-source magnetic-odometry algorithm
MAINS, leveraging the open dataset from [2]. In this comparison, MAINS employs the rectangular sensor configuration
with 30 magnetometers. Fig.3 present the trajectory estimation
results of both algorithms on the public dataset. Tab.I summarizes the Root Mean Square (RMS) horizontal position and
velocity errors for the two algorithms across the dataset.






6



10


8


6







8


6


4


2


0


-2


-4


-6


-8



|Col1|Col2|Col3|Col4|Col5|Ref|
|---|---|---|---|---|---|
||||||**MAINS**<br>**MSCKF-MIO**|
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||


-5 0 5

**x [m]**


(c) LP-3



4


2


0


-2


-4


-6

|Col1|Col2|Col3|Col4|Col5|Ref<br>MAINS<br>MSCKF-MIO|
|---|---|---|---|---|---|
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||



-5 0 5

**x [m]**


(a) LP-1


Fig. 3. Trajectory estimation results of OA dataset



8


6


4


2


0


-2


-4


-6


-8


|Col1|Col2|Col3|Col4|Col5|Ref<br>MAINS<br>MSCKF-MIO|
|---|---|---|---|---|---|
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||



-5 0 5

**x [m]**


(b) LP-2



Fig.3 demonstrates the trajectory estimation comparison
under a scenario with an average altitude of 0.50 m. The
comparison reveals that MAINS exhibits significant cumulative position errors during multi-loop motion, accompanied
by rapid divergence in heading angle estimates. In contrast,
the proposed MSCEKF-MIO algorithm effectively suppresses
position error accumulation through its enhanced magnetic
field model and multi-state constraint mechanism, maintaining
tight adherence to the reference trajectory within bounded
deviations.

According to the statistical results, the proposed MSCEKFMIO achieves an RMS horizontal position error of approximately 0.50 m on the dataset with an average altitude of 0.50
m, representing an 85% improvement compared to MAINS
(3.44 m). Notably, in velocity estimation, MSCEKF-MIO
reduces the RMS error by 40% relative to MAINS, demonstrating that the enhanced magnetic field model and multistate constraints effectively improve the accuracy of velocity
estimation. Comparisons of localization results and statistical
metrics for the remaining public datasets, along with detailed
numerical values, are provided in Tab.VI and Fig.10. These
results confirm that the proposed MSCEKF-MIO algorithm
achieves high-precision localization on open datasets without
relying on external positional references (e.g., the 60-second
initial positional assistance required by MAINS).
Fig.10 shows both algorithms’ localization results diverging
significantly in position and heading. This behavior arises
because the dataset’s elevation remains between 0.70 m and

0.80 m. We hypothesize that, at this elevation, the magnetic
field gradient attenuates substantially, causing the gradient
variations detected by the magnetometer array to flatten. As
a result, this flattening introduces errors into the perturbation
model linking magnetic gradient variations to pose changes,
ultimately causing localization divergence.


_B. Results on Our dataset_


To further evaluate the performance of the proposed algorithm, a custom-developed sensor array platform (as illustrated
in Fig.4) was constructed, and extensive experimental data



TABLE I

E RROR S TATISTICS OF P UBLIC D ATASET -1


Data sequence **LP-1** **LP-2** **LP-3**
Trajectory length (m) 114.14 139.87 192.93
Trajectory duration (s) 212 226 332
Average height (m) 0.49 0.52 0.53
**MAINS**

RMS (m) 3.15 3.61 3.56
CDF68 (m) 3.36 4.11 3.75
RMS Speed (m/s) 0.09 0.10 0.12
**MSCEKF-MIO**

RMS (m) 0.49 0.58 0.58
CDF68 (m) 0.53 0.66 0.61
RMS Speed (m/s) 0.06 0.07 0.07

1 LP: low height and parallel NP: normal height and
parallel NT: normal height and tilted.


Fig. 4. Sensor array platform


was collected across multiple indoor scenarios. Scenario a:
office building lobby, Scenario b: underground parking garage,
Scenario c: indoor corridor.

The sensor array platform is equipped with five 9-axis
sensor modules (HWT-9073) and one LiDAR (Livox Mid360). Each HWT-9073 module integrates a 3-axis gyroscope,
3-axis accelerometer, and 3-axis magnetometer. The Livox
Mid-360 LiDAR captures point cloud data and is paired with
the Fast-LIO2 algorithm [13] to compute reference poses for
indoor pedestrian tracking, achieving decimeter-level accuracy.
Magnetometers are prone to interference from onboard


(a) Scenario-a (b) Scenario-b (c) Scenario-c


Fig. 5. Data acquisition environment


TABLE II

INFORMATION ABOUT THE DATASETS


**Data sequence** **Average height(m)** **Length(m)** **Duration(s)**
aL-1 0.41 146.32 156

aL-2 0.40 143.60 145

aM-1 0.54 149.79 177

aM-2 0.68 148.49 155

aN-1 0.84 137.72 132

aN-2 0.80 138.14 139

bM-1 0.68 247.17 254

bM-2 0.63 248.49 303

cM-1 0.54 155.75 175

cM-2 0.50 154.77 173


L: low height M: medium height N: normal height


or environmental magnetic disturbances, particularly soft-iron
effects, which can cause misalignment between the magnetometer and inertial sensor frames. Therefore, magnetometer
calibration and alignment with inertial sensors are necessary
before using the magnetometer array for data collection. In
the data preprocessing stage of this experiment, a Kalman
filter-based magnetometer calibration and alignment algorithm
from [14] was applied to ensure measurement accuracy. For
the experiments, a pedestrian acted as the carrier of the
magnetic-inertial odometry system. During data collection, the
pedestrian held the platform and maintained it at a fixed height
above the ground. A total of 10 datasets were collected, with
the characteristics of each dataset detailed in Tab.II.

All datasets are processed using two algorithms: MAINS
proposed in [2] and the MSCEKF-MIO algorithm presented in
this work. Fig.6 illustrate the horizontal positioning results of
both algorithms across three different experimental scenarios.



7


Tab.III provides the statistical metrics of positioning results
for two datasets per scene in the three scenarios.


TABLE III

T HE HORIZONTAL POSITION AND VELOCITY ERROR STATISTICS OF OUR

DATASET


Data sequence **aM-1** **aM-2** **bM-1** **bM-2** **cM-1** **cM-2**
**MAINS**

RMS (m) 6.09 9.04 7.61 12.58 4.66 3.11
CDF68 (m) 6.80 9.79 7.99 12.94 4.81 3.39
RMS Speed (m/s) 0.21 0.21 0.19 0.20 0.23 0.24
**MSCEKF-MIO**

RMS (m) 1.88 3.13 3.07 2.77 2.58 2.48
CDF68 (m) 2.23 4.00 3.33 3.08 2.98 3.07
RMS Speed (m/s) 0.12 0.15 0.13 0.11 0.13 0.14


The experimental results demonstrate that the proposed
MSCEKF-MIO algorithm exhibits significant advantages in
horizontal positioning accuracy compared to the MAINS algorithm. As shown in Fig.6, under closed-loop multi-lap path
testing scenarios, the MAINS algorithm displays noticeable
trajectory drift (RMS error _>_ 4 m), whereas the MSCEKF-MIO
maintains close alignment with the reference trajectory (RMS
error _<_ 2.5 m). Quantitative comparisons in Table 3 further
validate this conclusion: on datasets with trajectory lengths of
150–250 m, the 68% cumulative distribution function (CDF68)
value of horizontal position errors for MSCEKF-MIO averages
approximately 2.4 m, representing a reduction of about 60%
compared to MAINS (6.3 m).
Furthermore, the trajectory estimation results of the MAINS
algorithm exhibit high sensitivity to the noise parameters
of the magnetic field model. When the testing environment
changes, the noise parameters of the magnetic field model
require recalibration to match the true magnetic conditions. In
contrast, the proposed MSCEKF-MIO does not incorporate the
magnetic field model as a state variable. Instead, it constructs
geometric constraints using pose information from multiple
epochs and performs EKF updates. By eliminating excessive
reliance on magnetic field modeling and reducing the degrees
of freedom in state estimation, the algorithm enhances positioning accuracy and delivers more stable localization results.


20



|Col1|Col2|Col3|Col4|Ref<br>MAI|NS|
|---|---|---|---|---|---|
||||**MS**|**MS**|**KF-MIO**|
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||


-20 -10 0 10 20

**x [m]**


(b) bM-1



15


10


5


0


-5


-10


-15


-20



5





|Col1|Col2|Col3|Col4|Ref<br>MAIN|S|
|---|---|---|---|---|---|
||||**MSC**|**MSC**|**F-MIO**|
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||
|||||||


0 10 20 30

**x [m]**


(c) cM-1



0


-5


-10


-15

|Col1|Col2|Col3|Col4|Ref<br>MAINS|Col6|
|---|---|---|---|---|---|
|||||**MSCKF-MI**|**O**|
|||||||
|||||||
|||||||
|||||||



-10 -5 0 5 10

**x [m]**


(a) aM-1


Fig. 6. Trajectory estimation results of our dataset



25


20


15


10


5


0


-5


-10


-15


-20


-25


8



(a) aL-1 (b) aL-2


(c) aM-1 (d) aM-2


Fig. 7. Comparison of Heading Angle Errors With and Without n-Frame Magnetic Vector Constraint



_C. Analysis of N-frame Mag Constraint_


To validate the optimization effect of the n-frame magnetic
vector attitude constraint in the proposed algorithm on attitude
estimation, this section designs a comparative experiment
based on the acquired reference attitude of indoor trajectories.
In the MSCEKF-MIO solution process, the n-frame magnetic
vector attitude constraint is first disabled and then enabled,
and the calculated heading angles are compared with the
reference heading angles. The RMS values of the heading
angle deviations are statistically analyzed. Fig.7 presents the
heading angle error comparisons for the four datasets (aL-1 to
aM-2), and Tab.IV provides the corresponding RMS statistics
of heading angle errors.
As shown in Fig.7, the heading angle error exhibits significant temporal divergence when the n-frame magnetic vector
constraint is disabled. By the end of the trajectory, the maximum heading deviation approaches 40°. This phenomenon
confirms that the heading angle in magneto-inertial odometry
remains in an unobservable state in the absence of absolute

heading references. In contrast, enabling the magnetic constraint substantially reduces the divergence rate of heading
errors. According to the statistical metrics in Tab.IV, the
RMS heading error remains consistently below 2°. These
results demonstrate that introducing the local n-frame magnetic vector constraint effectively mitigates heading drift under
unobservability conditions. The average RMS heading error
decreases from 9.8° to 1.80°, achieving an approximately 70%
improvement in heading estimation accuracy.


_D. Analysis of the Impact of Magnetic Field Gradients_


The proposed algorithm utilizes a magnetometer array to
measure spatial magnetic gradient variations and constructs
constraint information based on the relationship between local gradient changes and the platform’s pose. Consequently,


TABLE IV

RMS H EADING A NGLE E RROR S TATISTICS (U NIT : °)


**aL-1** **aL-2** **aM-1** **aM-2**

OFF 3.97 8.90 6.52 19.89

ON 1.82 1.55 1.94 1.90



significant magnetic gradient variations in the localization environment are critical for the performance of magneto-inertial
odometry. Due to the cubic decay of magnetic field strength
with distance, this experiment controls the prominence of
magnetic gradients by adjusting the sensor platform’s height
above the indoor ground. Furthermore, the impact of different
gradient magnitudes on odometry performance is analyzed.
Fig.8 display velocity estimation results at varying heights
within the same indoor environment. Tab.V lists the corre
sponding RMS velocity estimation errors, and Fig.9 shows
the RMS error variation with height across the dataset.
The RMS velocity error statistics of the MSCEKF-MIO
algorithm in Tab.V demonstrate that magnetic gradient prominence decisively influences algorithmic performance. In the
low-height groups (aL-1/aL-2), the mean RMS velocity error
is only 0.075 m/s; in the mid-height groups (aM-1/aM-2), the
error rises to 0.135 m/s; and in the normal-height groups (aN1/aN-2), it further increases to 0.17 m/s. This indicates that
weakened magnetic gradients introduce significant noise into
magnetometer array observations. Nevertheless, MSCEKFMIO’s error in normal-height groups remains significantly
lower than MAINS (RMS error: 0.34–0.35 m/s).


V. C ONCLUSIONS AND F UTURE W ORK


This paper proposes a multi-state constrained magnetic
array inertial odometry method (MSCEKF-MIO). The algorithm constructs an environmental magnetic field distribution
model through magnetometer array observations and estimates
the platform’s absolute velocity by tracking temporal variations in the magnetic model derived from continuous array
measurements. These estimates are then used to correct the

position, velocity, and attitude obtained via IMU integration.
Experimental results demonstrate that the proposed algorithm
achieves high localization accuracy in environments with significant magnetic gradient variations. With fewer sensors than
MAINS, MSCEKF-MIO exhibits superior performance in both


TABLE V

RMS V ELOCITY E RROR S TATISTICS (U NIT : M / S )


**aL-1** **aL-2** **aM-1** **aM-2** **aN-1** **aN-2**

MAINS 0.27 0.26 0.21 0.21 0.34 0.35

MSCEKF-MIO 0.07 0.08 0.12 0.15 0.18 0.16


9



(a) aL-1


(b) aM-1


(c) aN-1


Fig. 8. Velocity Estimation Results at Varying Heights in the Same Indoor Environment



Fig. 9. Velocity Error vs. Height


velocity and attitude estimation. As a magneto-inertial odometry framework that requires neither motion assumptions nor
prior magnetic fingerprint databases, this work provides a lowpower, cost-effective, and highly reliable localization solution
for indoor platforms (particularly in tunnels or for pedestrians) under non-cooperative and prior-free conditions. Future
work will focus on enhancing the algorithm’s performance
in environments with attenuated magnetic gradients. Potential
directions include integrating magnetic waveform sequence
matching to improve velocity estimation under weak gradient
scenarios and leveraging sensors mounted on other body parts
to establish collaborative constraints, thereby forming a body
sensor network with cooperative localization capabilities.


R EFERENCES


[1] S. A. S. Mohamed, M.-H. Haghbayan, T. Westerlund, J. Heikkonen,
H. Tenhunen, and J. Plosila, “A Survey on Odometry for Autonomous
Navigation Systems,” IEEE Access, vol. 7, pp. 97466–97486, 2019, doi:
10.1109/ACCESS.2019.2929133.

[2] C. Huang, G. Hendeby, H. Fourati, C. Prieur, and I. Skog, “MAINS: A
Magnetic Field Aided Inertial Navigation System for Indoor Positioning,”
IEEE Sens. J., pp. 1–1, 2024, doi: 10.1109/JSEN.2024.3379932.




[3] D. Vissiere, A. Martin, and N. Petit, “Using distributed magnetometers to
increase IMU-based velocity estimation into perturbed area,” in 2007 46th
IEEE Conference on Decision and Control, Dec. 2007, pp. 4924–4931.
doi: 10.1109/CDC.2007.4434809.

[4] E. Dorveaux, “Magneto-inertial navigation: principles and application to
an indoor pedometer,” Nov. 2011. Accessed: Jan. 12, 2024. [Online].

[5] C.-I. Chesneau, M. Hillion, and C. Prieur, “Motion estimation of a
rigid body with an EKF using magneto-inertial measurements,” in 2016
International Conference on Indoor Positioning and Indoor Navigation
(IPIN), Alcala de Henares, Spain: IEEE, Oct. 2016, pp. 1–6. doi:
10.1109/IPIN.2016.7743702.

[6] M. Zmitri, H. Fourati, and C. Prieur, “Improving Inertial Velocity
Estimation Through Magnetic Field Gradient-based Extended Kalman
Filter,” in 2019 International Conference on Indoor Positioning and Indoor
Navigation (IPIN), Sep. 2019, pp. 1–7. doi: 10.1109/IPIN.2019.8911813.

[7] I. Skog, G. Hendeby, and F. Gustafsson, “Magnetic Odometry - A
Model-Based Approach Using a Sensor Array,” in 2018 21st International
Conference on Information Fusion (FUSION), Jul. 2018, pp. 794–798.
doi: 10.23919/ICIF.2018.8455430.

[8] C. Huang, G. Hendeby, and I. Skog, “A Tightly-Integrated MagneticField aided Inertial Navigation System,” in 2022 25th International
Conference on Information Fusion (FUSION), Jul. 2022, pp. 1–8. doi:
10.23919/FUSION49751.2022.9841304.

[9] T. Zhang, L. Wei, J. Kuang, H. Tang, and X. Niu, “Mag-ODO:
Motion speed estimation for indoor robots based on dual magnetometers,” Measurement, vol. 222, p. 113688, Nov. 2023, doi:
10.1016/j.measurement.2023.113688.

[10] W. Zhang, “Ped-Mag-ODO: Indoor Pedestrian Motion Speed Estimation
Method Based on Dual Magnetometers,” IEEE Internet Things J., vol. PP,
pp. 1–1, Jan. 2024, doi: 10.1109/JIOT.2024.3512504.

[11] A. I. Mourikis and S. I. Roumeliotis, “A Multi-State Constraint Kalman
Filter for Vision-aided Inertial Navigation,” in Proceedings 2007 IEEE
International Conference on Robotics and Automation, Apr. 2007, pp.
3565–3572. doi: 10.1109/ROBOT.2007.364024.

[12] J. A. Hesch, D. G. Kottas, S. L. Bowman, and S. I. Roumeliotis,
“Consistency Analysis and Improvement of Vision-aided Inertial Navigation,” IEEE Trans. Robot., vol. 30, no. 1, pp. 158–176, Feb. 2014, doi:
0.1109/TRO.2013.2277549.

[13] W. Xu, Y. Cai, D. He, J. Lin, and F. Zhang, “FAST-LIO2: Fast Direct
LiDAR-inertial Odometry”.

[14] Y. Wu, D. Zou, P. Liu, and W. Yu, “Dynamic Magnetometer Calibration
and Alignment to Inertial Sensors by Kalman Filtering,” IEEE Trans.
Control Syst. Technol., vol. 26, no. 2, pp. 716–723, Mar. 2018, doi:
10.1109/TCST.2017.2670527.


10



TABLE VI

E RROR S TATISTICS OF P UBLIC D ATASET -2


Data sequence **NP-1** **NP-2** **NP-3** **NT-1** **NT-2**
Trajectory length (m) 136.23 132.17 137.76 164.62 137.87
Trajectory duration (s) 177 164 154 185 151
Average height (m) 0.85 0.83 0.79 0.73 0.74
**MAINS**

RMS (m) 3.62 2.35 4.21 6.23 3.83
CDF68 (m) 3.77 2.55 4.37 7.25 4.63
RMS Speed (m/s) 0.25 0.19 0.29 0.17 0.14
**MSCEKF-MIO**

RMS (m) 3.56 6.68 3.58 3.71 2.87
CDF68 (m) 4.12 7.39 4.11 4.39 3.34
RMS Speed (m/s) 0.17 0.26 0.22 0.10 0.09

1 LP: low height and parallel NP: normal height and parallel NT: normal
height and tilted.



|Col1|Col2|Col3|Col4|Ref<br>MAINS<br>MSCKF-MIO|
|---|---|---|---|---|
||||||
||||||
||||||
||||||
||||||
||||||
||||||
||||||
||||||
||||||


-5 0 5

**x [m]**


(b) NP-3

|Col1|Col2|Col3|Col4|Ref<br>MAINS|
|---|---|---|---|---|
||||||
||||||
|||||**MSCKF-MIO**|
||||||
||||||
||||||
||||||
||||||
||||||
||||||
||||||



-5 0 5

**x [m]**


(d) NT-2



10


8


6


4


2


0


-2


-4


-6


10



|Col1|Col2|Col3|Col4|Ref<br>MAINS<br>MSCKF-MIO|
|---|---|---|---|---|
||||||
||||||
||||||
||||||
||||||
||||||
||||||
||||||
||||||
||||||


-5 0 5

**x [m]**


(a) NP-1



10


8


6


4


2


0


-2


-4


-6


10


8


6


4


2


0


-2


-4


-6


-8



8


6


4


2


0


-2


-4


-6

|Col1|Col2|Col3|Col4|Ref<br>MAINS|
|---|---|---|---|---|
||||||
||||||
|||||**MSCKF-MIO**|
||||||
||||||
||||||
||||||
||||||
||||||
||||||
||||||



-5 0 5

**x [m]**


(c) NT-1


Fig. 10. Localization results for the remaining open datasets


