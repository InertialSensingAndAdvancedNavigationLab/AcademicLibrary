#  ( ) 3 based Extended Kalman Filter for Spacecraft **Attitude Estimation**

Lubin Chang [*]


_Naval University of Engineering, Wuhan, 430033, China_


**Abstract** : In this paper, the spacecraft attitude estimation problem has been


investigated making use of the concept of matrix Lie group. Through formulation of

##### the attitude and gyroscope bias as elements of  ( ) 3, the corresponding extended Kalman filter, termed as  ( ) 3 -EKF, has been derived. It is shown that the resulting  ( ) 3 -EKF is just the newly-derived geometric extended Kalman filter (GEKF) for


spacecraft attitude estimation. This provides a new perspective on the GEKF besides

##### the common frame errors definition. Moreover, the  ( ) 3 -EKF with reference frame


attitude error is also derived and the resulting algorithm bears much resemblance to


the right invariant EKF.


**Keywords** : Attitude estimation; extended Kalman filter; matrix Lie group; special


Euclidean group.

##### **1. Introduction**


Spacecraft attitude estimation using vector observations has drawn much attention


since the 1960s. For this problem, two facts have been widely approved, that is,


gyroscopes are used in “dynamic model replacement mode” [1] and the utility of


employing quaternions for attitude parameterization is preferred [2]. For the first fact,


since the gyroscopes have been used, the gyroscope bias is always estimated coupled


- Associated Professor, Department of Navigation Engineering, No. 717 Jiefang Road, Wuhan,


430033, China. changlubin@163.com


with the attitude. For the second fact, many filtering methods have been devoted to


handling the constraints inherent to non-minimal attitude representation. The extended


Kalman filter (EKF) in multiplicative form (MEKF) is the workhorse for on-board


attitude estimation due to its flexibility and computational efficiency [2-4]. However,


the EKF may prone to divergence when dynamics or measurement models are highly


nonlinear, or there is no good a priori state estimate. In this case, some advanced


nonlinear filtering algorithms can be applied [5-10]. For more details about the


advanced attitude estimators until 2006, the comprehensive and excellent survey


paper [4] can be referred. It should be noted that most of these previous attitude


estimators put much effort on the attitude part of the state vector. Non-attitude state


vectors have still been handled in the general vector-space. From the perspective of


matrix Lie group, these attitude estimators can be viewed as the extensions of general

##### filters on special orthogonal group, i.e.  ( ) 3 .


In recent few years, a filter called geometric extended Kalman filter (GEKF) has been


well studied for attitude estimation [11-14]. It has been demonstrated that the GEKF


can outperform the MEKF. The main concept of GEKF is a new state-error definition


with involved errors expressed in a common frame. The common frame is established


making use of the estimated attitude error in each filtering recursion. Compared with


the traditional state-error in vector-space, the frame consistent errors are more


representative of the real errors experienced by the system. The frame consistent error


is nonlinear due to error-attitude coupling with the states. In contrast with the linear


error in vectorspace, such nonlinear error can be viewed as on manifold [15-18]. The


above viewpoint motives us to revisit the GEKF making use of the concept of Lie


group whose operations are just performed on manifold. In this note, we formulate the

##### attitude matrix and gyroscope bias as elements of special Euclidean group  ( ) 3, a


representative of the Lie group. The detailed filtering equations are derived making


use of matrix Lie group and Lie algebra theories for spacecraft attitude estimation.

##### The resulting attitude estimation algorithm is termed as  ( ) 3 − EKF . It is revealed


that the GEKF with body frame attitude error bears much resemblance to, and thus

##### can be viewed as, a kind of the  ( ) 3 − EKF . This provides another perspective on the GEKF besides the common frame errors definition. Moreover, the  ( ) 3 − EKF


with reference frame attitude error is also derived and the resulting algorithm bears


much resemblance to the right invariant EKF (RIEKF) proposed in [19].


The organization of this paper proceeds as follows. In Section 2, the matrix Lie group


and spacecraft attitude estimation model using vector observations have been

##### introduced as mathematical preliminaries. In Section 3, the  ( ) 3 − EKF with body


frame attitude error is derived. Its relationship with GEKF is also revealed and

##### discussed. The  ( ) 3 − EKF with reference frame attitude error is derived in Section 3.


Some conclusions are drawn in the final section.

##### **2. Mathematical Preliminaries**


In this section, the mathematical preliminaries related with matrix Lie group, Lie


algebra and spacecraft attitude estimation model are provided, which will be used to

##### derive the  ( ) 3 − EKF in the following sections.


**2.1** **Matrix Lie Groups and Lie Algebra**

##### The special Euclidean group  ( ) 3, which is always used to represent the poses, is


simply the set of valid transformation matrices as [20]

#### = ( ) 3 = Ψ { ( R t, ) ; R ∈ = ( ) 3, t ∈  3 } (1)

##### where  ( ) 3 is special orthogonal group, representing rotations.  ( ) 3 and  ( ) 3


are both types of matrix Lie group .The map Ψ is given by



 **R** **t** 
##### Ψ : ( R t, )   

 **0** 1 3 × 1 



 **R** **t** 
##### R t, )   

 **0** 1 3 × 1 

((


##### ( R t, )



:,  

 **0** 1 3 × 1



(2)



**T**

##### The inverse of an element of  ( ) 3 is given by



1



− _T_ _T_



− 1  **R** **t**  **R** − **R t**

**T** =   = 
**0** 1 **0** 1



1



 **R** **t**  −  **R** _T_ − **R t** _T_ 
= = ∈
   
 **0** 1 3 × 1   **0** 1 3 × 1 



 =   ∈ = 3

1 3 × 1   **0** 1 3 × 1 



= 3 (3)


##### ( ) 3



−



× ×



With every matrix Lie group is associated a Lie algebra. The Lie algebra associated

##### with  ( ) 3 is given by


4 4 × 6
### se ( ) 3 = { £ se ( ) 3 [( )] ζ ∈  ζ ∈  } (4)


where



^


#####  φ   φ   ( φ × ) μ  £ se ( ) 3 [( )] ζ = £ se ( ) 3  μ  =  μ  =  0 1,3 0 


#####  φ   φ   ( φ × ) ( ) 3 [( )] ζ = £ se ( ) 3   =   = 



**φ** **φ** **φ** × **μ**
##### se ( ) 3 [( )] ζ = £ se ( ) 3  μ  =  μ  =  0 0  (5)



3 se ( ) 3  **μ**   **μ**   **0** 1,3



The relation between a matrix Lie group to its associated Lie algebra is given by the

##### exponential map . The elements of  ( ) 3 are related to the elements of se ( ) 3 through



∞

^ 1 ^ _n_  **C** **Jμ** 
# T = exp ( ) ζ = ∑ ( ) ζ =   ∈ = ( ) 3 (6)

_n_ = 0 _n_ !  **0** 1 3 × 1 



∞

^ 1 ^ _n_ **C** **Jμ**
# exp ( ) ζ = ∑ ( ) ζ =   ∈ = 3

_n_ ! **0** 1



∞



_n_



^ ^ _n_
# ( ) ζ = ∑ ( ) ζ =   ∈ = ( ) 3



_n_ = 0 _n_



0 1 3 ×



= ×



where



∞ 1
# exp ( φ × = ) ∑

_n_ !



∞



_n_
# C = exp ( φ × = ) ∑ ( φ × ) (7)

= _n_ !


# ( φ × = ) ∑ ( φ × )



_n_



_n_ = 0 _n_



0



∞



_n_
# J = ∑ φ × ) (8)
##### = n + 1 ! [(]



_n_



_n_ = 0 _n_



1


+ 1 !



0


##### φ × ) n + 1 ! [(] ( )



Let **φ** =ϕ **a** where ϕ is the angle of rotation and **a** = **φ** ϕ is the unit-length axis of


rotation. A direct series expression for **T** from the exponential map can also be


obtained as


^ ^  1 cos − ϕ  ^ 2 ϕ− sin ϕ  ^ 3
#### exp ( ) ζ = I 4 4 × + ζ +  2  ( ) ζ +  3  ( ) ζ (9)
 ϕ   ϕ 



2 − 3



^ ^ − ϕ ^ ϕ− ϕ ^
#### ( ) ζ = I 4 4 × + ζ +  2  ( ) ζ +  3  ( ) ζ



**2.2** **Spacecraft Attitude Estimation Model**


_T_ _T_ _T_
##### Denote the attitude quaternion as q =  ρ q 4  with ρ = [ q q q 1 2 3 ] being the vector


component. The spacecraft attitude kinematics model in terms of quaternion is given


by


 1
##### q ( ) t = Ξ  q ( ) t  ω ( ) t (10)

2


where


#####  q I 4 3 3 × + [ ρ × ]  Ξ [ ] q =  − ρ T 

**ω** is the angular rate measured by the gyroscopes and governed by



(11)





**ω** = **ω** + **β** + **η** **v**

 (12)



**ω** = **ω** + **β** + **η**



**v**



= **ω** + +



=

**β** **η**



=



**u**



where **β** is the constant gyroscope bias. **η** and **v** **η** **u** are assumed to be zero-mean,


Gaussian white-noise processes.


The measurement model with _n_ vector observations is given by


##### ( )


##### A q r ( ) 1  υ 1 

**y** _k_ =    +    (13)
#####  A q r ( )   υ 



1 1



_k_


#####  A q r ( ) 1   υ 1 

=    +   
   
#####  A q r ( ) n  t  υ n 


##### ( )



_n_ _t_ _k_ _n_ _t_ _k_



where **A q** ( ) is the attitude matrix corresponding to quaternion **q** . **[υ]** [ is the measurement ] _i_


white noise for the _i_ -th vector observation.

##### 3.  ( ) 3 − EKF with Body Frame Attitude Error


In this note, we follow the attitude error terminology in [3, 11] with emphases on the


expressed frames of the attitude error. More specifically, given true quaternion related


attitude matrix **A q** ( ) and its estimate **A q** ˆ( ), the body frame attitude error is given


by **A q A q** ( ) ( )ˆ [−] 1 and the reference attitude error is given by **A q** ˆ( ) − 1 **A q** ( ) . This is a little


difference with the terminology used in Lie group where **A q A q** ( ) ( )ˆ [−] 1 is termed as


_right_ error and **A q** ˆ( ) − 1 **A q** ( ) as _left_ error. Due to different representations of the attitude


quaternion, the _right_ attitude error may be expressed in reference frame [21]. With the

##### attitude error terminology in [3, 11], we will firstly derive the  ( ) 3 − EKF with body


frame attitude error definition in this section.

##### Define the state as X = [ A q β ( ), . The transformation matrix corresponding to the state ]


is given by



 **A q** ( ) **β** 
##### = Ψ ( ) X =  

 **0** 1 3 × 1 



 **A q** ( ) **β** 
##### χ = Ψ ( ) X =   (14)

**0** 1


##### ( ) X



( )



1 3 × 1



1 3 ×



Assume the estimate of **χ** is ˆ **χ** . The estimation error is defined as



ˆ − 1  **A q A q** ( ) ( )ˆ − 1 **β** − **A q A q** ( ) ( )ˆ − 1 **β** ˆ 

=

**χχ** =  

 **0** 1,3 1 



ˆ − 1 =  **A q A q** ( ) ( )ˆ − 1 **β** − **A q A q** ( ) ( )ˆ − 1 **β** ˆ

**0** 1



ˆ − 1 − ˆ − 1

1 **A q A q** ( ) ( ) **β** **A q A q** ( ) ( )



(15)



− −

−

ˆ − 1 **A q A q** ( ) ( ) **β** **A q A q** ( ) ( ) **β**

=

**γ** **χχ** = 
**0** 1



1,3



In the derivation of (15), the equation (3) has been used. It is clearly shown that the

##### estimation error is also well-defined on the group  ( ) 3 .According to relationship


between matrix Lie group to its associated Lie algebra, **γ** can also be obtained as


^
**γ** = exp **dx** (16)
#### ( )


where **dx** ∈  6 .The linearized error dynamic model of **dx** can be given by


 ˆ ˆ
##### dx ( ) t = F χ ( ( ), t t ) dx ( ) t + G χ ( ( ), t t ) w ( ) t (17) where ( F χ ˆ( ), t t ) and G χ ( ˆ( ), t t ) are the Jacobians with respect to the estimation error


and system noise on matrix Lie group, respectively. Once the associated Jacobians are


calculated, the general EKF framework can be applied to update the error-state.


According to (9), a first order approximation of **γ** is given by


^ ^
#### γ = exp ( dx ) ≈ I 4 4 × + dx (18)


According to [13], the first-order approximation of the error-attitude matrix is given


by

##### A δq ( ) = A q A q ( ) ( )ˆ [−] 1 ≈ I 3 3 × − ( δα × ) (19)


where **δα** has components of roll, pitch and yaw error angles for any rotation


sequence.


Substituting (19) into (15) yields



ˆ ˆ
#####  I 3 3 × − ( δα × ) β − β + δα β × 

≈ 
 **0** 1 3 × 1 


##### 3 3 × − ( δα × )



ˆ ˆ


##### I 3 3 × − ( δα × ) β − β + δα β ×

**γ** ≈
**0** 1



×



1 3 ×



1



×



Comparing (18) and (20), the definite expression of **dx** can be obtained as


 − **δα**   − **δα**   **dα** 

**dx** =  ˆ ˆ  =  ˆ  =  

 **β** − **β** + **δα β** ×  ∆+ **β** **δα β** ×   **dβ** 


where **dα** and **dβ** is clearly defined in (21).


According to [3], the explicit models of **δα** and ∆ **β** are given by



(20)


(21)



 ˆ
##### δα = − ( ω × ) δα −∆+ ( β η v ) (22)


∆= **β**  **η** **u** (23)


ˆ  ˆ
where **ω** = **ω** − **β** .Next, we will derive the models of **dα** and **dβ** according to their


definitions in (21) using the existing models (22) and (23).


Rewrite the definition of **dβ** as


ˆ
**dβ** = ∆+ **β** **δα β** × (24)


Taking the time derivative of (24) gives



   ˆ ˆ



ˆ ˆ



**dβ** = ∆+ **β** **δα β**  × + **δα β** ×



= ∆+  × + ×



ˆ ˆ



ˆ
##### ( ( ω × ) δα −∆+ ( β η v ) )



**η** **u** + − **ω** × **δα** −∆+ **β** **η** **v** × **β**



= + − **ω** × **δα** −∆+ ×



**u** **v**



ˆ ˆ ˆ ˆ
### ( β × ) ( ω × ) δα + ( β × ∆+ ) β ( β × )



ˆ ˆ ˆ ˆ



**β** × **ω** × **δα** + **β** × ∆+ **β** **β** × **η** **v** + **η**



= × **ω** × **δα** + × ∆+ × +



**v** **u**



ˆ ˆ ˆ ˆ ˆ
### ( β × ) ( ω × ) δα + ( β × )( dβ − δα β × ) ( + β × )



ˆ ˆ ˆ ˆ ˆ



**β** × **ω** × **δα** + **β** × **dβ** − **δα β** × + **β** × **η** **v** + **η**



= × **ω** × + × − × + × +



**v** **u**



(25)


(26)



ˆ ˆ ˆ ˆ
### ( β × ) ( ω × ) dα + ( β × ) dβ + ( β × )



ˆ ˆ ˆ ˆ



**β** × **ω** × **dα** + **β** × **dβ** + **β** × **η** **v** + **η**



= − × **ω** × + × + × +



**v** **u**



In (25), we have made use of the definition **dα** = − **δα** .


Substituting (24) into (22) gives







ˆ ˆ
### ( ω × ) δα − ( dβ − δα β × + η v )



ˆ ˆ





**δα** = − **ω** × **δα** − **dβ** − **δα β** × + **η**



= − **ω** × − − × +



**v**



ˆ ˆ
( **ω** + **β** ) ×
### ( )



( **ω** ˆ + **β** ˆ )



**ω** + **β** ) × **δα** − **dβ** − **η**



**v**



= − **ω** + × − −



**ω**  ×
##### ( )







**ω** × **δα** − **dβ** − **η**



**v**



= − **ω** × − −



According to the definition **dα** = − **δα**, the model of the definition **dα** can be readily


obtained as

##### dα  = − ( ω  × ) dα + dβ + η v (27)


Based on (25) and (27), we can easily derive the Jacobians as




#####  − ( ω × ) I 3 3 ×  ˆ( ), t t )  ˆ ˆ ˆ 
### = − ( β × ) ( ω × ) ( β × ) 




#####  − ( ω × ) I 3 3 × ( ˆ( ), t t )  ˆ ˆ ˆ
### = − ( β × ) ( ω × ) ( β × )







− **ω** × **I**
##### ( ) F χ ( ˆ( ), t t )  ˆ ˆ ˆ = − β × ( ω × ) β



(28)



 **I** 3 3 × **0** 3 3 × 
=  ˆ 
 **β** × **I** 3 3 × 
###  ( ) 



 **I** 3 3 × **0** 3 3 × 
##### G χ ( ˆ( ), t t ) =  ˆ  (29)

 **β** × **I** 3 3 × 



3 3 × 3 3 ×



× ×
##### ˆ( ), t t ) =  ˆ

 **β** × **I** 3 3 ×
### ( )


##### ( ˆ( ), t t ) =  ˆ

 **β** ×
###  ( )



×



Next, we will derive the measurement transition matrix for the error-state **dx** . For a


single sensor the true and estimated body vectors are given by

##### b = A q r ( ) (30)


ˆ − ˆ −
**b** = **A q** **r** (31)
#### ( )


Subtracting (31) from (30) and making use of the approximation in (19) yield


ˆ − ˆ −
#### A δq A q ( ) ( ) r − A q ( )



ˆ − ˆ



− −

**b** **A δq A q** **r** − **A q** **r**



−

∆= **b** **r** −



− −



ˆ − ˆ −
#### ( I 3 3 × − ( δα × ) ) ( A q ) r − A q ( )



ˆ − ˆ



− −

**I** 3 3 × − **δα** × **A q** **r** − **A q** **r**



(31)



− −
× − **δα** × **A q** **r** − **A q**



= − × **r** −



3 3 ×



ˆ − ˆ −

=  **A q** **r** × **δα** = −  **A q** **r** ×
####  ( )   ( ) 



ˆ − ˆ −

**r** × **δα** = −  **A q**
#### ( )   ( )



ˆ − ˆ



**A q** − **r** × **δα** = − **A q** − **r** × **dα**



− −



Then, the linearized measurement model for multiple vector observations is given by



ˆ −
####  −  A q ( ) r 1 × 0 3 3 × 

 
= **Hdx** =    
 


ˆ −
#### −  A q ( ) r n × 0 3 3 × 


#### ( ˆ − )



ˆ



− **r** 1 × **0** ×



**A q** − **r** 1 × **0**



1 3 3 ×



  **dx** (32)



**y** = **Hdx** =   **dx**


#### ( ˆ − )



ˆ −

**r**

_n_



3 3 ×



**A q** − **r** × **0**



− **r** _n_ × **0** ×


##### Given the above derived state-space model, the  ( ) 3 − EKF for spacecraft attitude

estimation using vector observations is summarized in **Algorithm 1** .

##### Algorithm 1:  ( 3 ) − EKF with Body Frame Attitude Error

Initialize:


ˆ ˆ ˆ ˆ ˆ
##### X ( ) t 0 =  A q ( ( )), ( ) t 0 β t 0  =  A q ( 0 ), β 0 


_T_
**P** _t_ = _E_ **dx dx**
#### ( ) 0 ( 0 0 )

Gain:



− 1



_T_ _T_

**K** _k_ = **P** _k k_ − 1 **H** _k_  **H P** _k_ _k k_ − 1 **H** _k_ + **R** _k_ 
 
Update:


ˆ ˆ
**dx** _k_ = **K** _k_ **y** _k_ − _h_ ( **X** _k k_ − 1 )
### ( )



_T_ _T_

**K** _k_ = **P** _k k_ − 1 **H** _k_  **H P** _k_ _k k_ − 1 **H** _k_ + **R** _k_ 
 
Update:



ˆ ˆ ^ ˆ
### χ k = exp ( dx k ) ( Ψ X k k − 1 )
##### X ˆ k = Ψ − 1 ( χ ˆ k )

Propagation:

ˆ  ˆ
##### ω t ( ) = ω ( ) t − β ( ) t



ˆ 1 ˆ ˆ
##### q ( ) t = Ξ ( q ( ) t ) ω ( ) t

2



ˆ
##### ˆ  A q ( ˆ( ) t ) β ( ) t 

= Ψ **X** ( ) _t_ =  
### ( )
 **0** 1 3 × 1 



ˆ
##### ˆ ˆ  A q ( ˆ( ) t ) β t
### χ ( ) t = Ψ ( X ( ) t ) = 

**0** 1


##### ˆ A q ( ˆ( ) t ) β ( ) t
### ( ) t = Ψ ( X ( ) t ) = 


##### ˆ ˆ A q ( ˆ( ) t ) β
### χ ( ) t = Ψ ( X ( ) t ) = 

**0**



1 3 ×



×







ˆ _T_ ˆ
##### ( ) t = F χ ( ( ), t t ) ( ) P t + P ( ) t F ( χ ( ), t t ) + G ( χ ˆ ( t t ), ) Q k − 1 G ( χ ˆ ( t t ), )



ˆ ( ), _t t_ **P** _t_ + **P** _t_ **F** **χ** ˆ ( ),



**P** _t_ = **F χ** ( ), _t t_ **P** _t_ + **P** _t_ **F** **χ**



_t_ = _t t_ **P** _t_ + **P** _t_ **F** _t t_



= _t t_ _t_ +



_T_



+



**G χ** ˆ ( _t t_ ), **Q** _k_ − 1 **G χ** ˆ



ˆ ( _t t_ ), **Q** − **G χ** ˆ ( ),



_t t_ − **χ** _t t_



_k_



ˆ
In Algorithm 1, **H** and _k_ _h_ **X** _k k_ − 1 are given by
### ( )



ˆ


_k k_ − 1
### ( )



ˆ



**A q** − **r** _k_ 1 × **0**



_k k_ − 1 _k_



1 _k_ 1 3 3 ×



− ×



**H**

_k_



ˆ

−  **A q** _k k_ − 1 **r** _k_ 1 × **0** 3 3 × 
###   ( )  
 

 

=  


ˆ

−  **A q** _k k_ − 1 **r** _kn_ × **0** 3 3 × 
###   ( )  



  (33)



ˆ


_k k_ − 1
### ( )



ˆ



**A q** − **r** _kn_ × **0**



_k k_ − 1 _kn_



1 _kn_ 3 3 ×



− ×


ˆ


_k k_ − 1
### ( )



ˆ



**A q** − **r** _k_



_k k_ − 1 _k_



1 _k_ 1



−



ˆ

 **A q** _k k_ − 1 **r** _k_ 1 
###  ( ) 
  
=  


ˆ

 **A q** _k k_ − 1 **r** _kn_ 
###  ( ) 



_k k_



1



_h_



ˆ

**X** _k k_ − 1
### ( )



ˆ

**X**



 (34)



−



ˆ


_k k_ − 1
### ( )



ˆ



**A q** − **r**



_k k_ − 1 _kn_



1



−



The transformation matrix estimate


ˆ ˆ ^ ˆ
### χ k = exp ( dx k ) ( Ψ X k k − 1 ) (35)


is corresponding to the transformation matrix error definition in (15). If we divide the


error-state **dx** as **dx** ˆ _k_  **dα** ˆ _kT_ **dβ** ˆ _kT_  _T_, according to the first order approximation of
=  


exponential map in (18), (35) can be further approximated as


### ( I 4 4 × + dx ˆ k ^ ) ( Ψ X ˆ k k − 1 )



ˆ ˆ ^ ˆ
#### χ k ≈ ( I 4 4 × + dx k ) Ψ X



4 4 × + **dx** ˆ _k_ ^ Ψ **X** _k k_ − 1



≈ **I** + **dx** Ψ



_k_ 4 4 × _k_ _k k_



× −



ˆ ˆ ˆ ˆ ˆ
### =  I 3 3 × + ( dα k × )  A q ( k k − 1 )  I 3 3 × + ( dα k × )  β k k − 1 + dβ k 

 **0** 1 3 × 1 



ˆ ˆ ˆ
### ( dα k × )  A q ( k k − 1 )  I 3 3 × + ( dα k × )



ˆ ˆ ˆ ˆ ˆ



(36)



**I** 3 3 × + **dα** _k_ × **A q** − **I** 3 3 × + **dα** _k_ × **β** − + **dβ**



_k_ _k k_ − 1 3 3 × _k_ _k k_ − 1 _k_



3 3 × _k_ _k k_ − 1 3 3 × _k_ _k k_ − 1



× − × −



**0**



1 3 ×



1



×



If we let


ˆ ˆ ˆ
##### A δq ( k ) =  I 3 3 × + ( dα k × )  =  I 3 3 × − ( δα k × )  (37)


The estimate Lie matrix **X** [ˆ] is given by _k_


ˆ ˆ ˆ ˆ ˆ ˆ
### X k =  A δq ( k ) ( A q k k − 1 ), A δq ( k ) β k k − 1 + dβ k  (38)


According to the aforementioned filtering recursion, if we use **δα** instead of **dα** to


represent the attitude error, the resulting state-space model is identical with that of the

##### GEKF. That is to say, the derived  ( ) 3 − EKF with body frame attitude error is just a


minor variant of the multiplicative form of the GEKF (set aside the covariance update


for the global state update). In other word, the GEKF for attitude estimation can be

##### viewed as a kind of EKF on group  ( ) 3 . This recognition provides another


viewpoint on the geometric error-state used in GEKF. The common frame


interpretation is virtually the physical meaning of the geometric error-state and the


#####  ( ) 3 based derivation can provide a mathematical perspective.

With the above perspective, the traditional MEKF can also be viewed as a kind

##### of  ( ) 3 − EKF . According to the invariance theory [15-18],  ( ) 3 − EKF bears better invariance properties than  ( ) 3 − EKF and therefore, can always outperforms the  ( ) 3 − EKF .This conclusion has been well demonstrated through the


comparisons between traditional MEKF and GEKF in [11]. The main utility of the

#####  ( ) 3 perspective lies in the nonlinear state-error construction. When other


parameters, such as gyroscope scale factors and misalignments, are added to the state


vector, we can construct the corresponding nonlinear state-error according to the


procedures (14) and (15). Actually, in practical applications, there may be no need to


define all the involved parameters errors on manifold and some can be defined still in


vector-space [22-24]. In this respect, we should firstly determine the group structure


3 × _m_
##### with the form  n ( ) 3 ×  where n is the number of the three-dimensional


parameters whose errors should be defined on manifold while _m_ is the number of


those should be defined in vector-space. With the defined group structure, we can


therefore determine the error-state and the corresponding state-space model.


It should be noted that there is no need to use (35) to update the state and the


first-order approximation in (38) is adequate. This is because that when deriving the


linear state-space model, first-order approximations (18) and (19) have been used.


Rigorously updating state using (35) isn’t likely to add any additional accuracy.

##### 4.  ( ) 3 − EKF with Reference Frame Attitude Error


Instead of definition of the attitude error in body frame, it can also be defined in


reference frame [25]. In contrast with (15), an alternative form of transformation


matrix error is defined as


 ˆ − 1 ˆ − 1 − ˆ 
### = χ χ ˆ − 1 =  A q ( ) A q ( ) A q ( ) ( β β ) 

 **0** 1 
 1,3 



 ˆ − 1 ˆ − 1 − ˆ
### 1 A q ( ) A q ( ) A q ( ) ( β β )



ˆ − 1 ˆ − 1 − ˆ
### χ χ ˆ − 1 =  A q ( ) A q ( ) A q ( ) ( β β

 **0** 1



− −

−

ˆ − 1 **A q** ( ) **A q** ( ) **A q** ( ) **β** **β**

**γ** = **χ χ** = 

 **0** 1



1,3



Making use of the approximation in (19), (39) can be approximated as



(39)


(40)


### ≈  I 3 3 × − ( δα × ) A q ˆ( ) − 1 ( β − β ˆ ) 

 **0** 1 3 × 1 


### 3 3 × − ( δα × ) A q ˆ( ) − 1 ( β − β ˆ )



− 1 − ˆ

ˆ( ) **β** **β**



−
##### I 3 3 × − ( δα × ) A q ˆ( ) β − β

**γ** ≈ 

 **0** 1



−
× − **δα** × **A q** ˆ( )



1 3 ×



1



×


##### Since γ ∈  ( ) 3, it can also be obtained as

^
**γ** = exp **dx** (41)
#### ( )


6
where **dx** ∈  . Making use of the first-order approximation in (18) and comparing


the approximated result of (41) with (40), we can obtain


 − **δα**   − **δα**   **dα** 
### dx =  A q ( ) ˆ − 1 ( β − β ˆ )  =  A q ( ) ˆ − 1 ∆ β  =  dβ  (42)


where **dα** and **dβ** is clearly defined in (42).


Next we will derive the state-space model of **dx** making use of the similar procedures


in Section III. The state-space model with reference frame attitude error for the


traditional MEKF is derived in Appendix. Based on the definitions of **dα** and **dβ** in (42)


and the attitude error model (A10), we can easily obtain the model of **dα** as


 ˆ _T_
##### dα = dβ + A q ( ) η v (43)


The model of **dβ** is given by



_T_ ˆ _T_



  


##### ( ) ˆ ∆+ β A q ( ) ˆ



ˆ ˆ



**dβ** = **A q** ∆+ **β** **A q** ∆ **β**



= ∆+ ∆



_T_ ˆ ˆ _T_


##### ( ) ( ˆ ω ˆ × ∆+ ) β A q ( ) ˆ



ˆ ˆ ˆ



**A q** **ω** × ∆+ **β** **A q** **η**



= **ω** × ∆+



**u**



_T_ ˆ ˆ ˆ _T_ ˆ _T_



ˆ ˆ ˆ ˆ ˆ
##### ( ) ( ω × ) A q A q ( ) ( ) ∆+ β A q ( )



ˆ ˆ ˆ ˆ ˆ



**A q** **ω** × **A q A q** ∆+ **β** **A q** **η**



(44)



= **ω** × ∆+



**u**



ˆ _T_ ˆ
##### =  A q ( ) ω × dβ +
##  ( ) 



ˆ _T_ ˆ ˆ
##### A q ( ) ω × dβ + A q ( )
## ( ) 



_T_ ˆ ˆ _T_



ˆ ˆ ˆ



**A q** **ω** × **dβ** + **A q** **η**



**u**



Based on (43) and (44), the state-space process model for **dx** is given by


 ˆ ˆ
##### dx ( ) t = F χ ( ( ), t t ) dx ( ) t + G χ ( ( ), t t ) w ( ) t (45)


where



 **0** 3 3 × **I** 3 3 × 
=  ˆ _T_ ˆ 
#####  0 3 3 ×  A q ( ) ω ×
###   ( ) 



 **0** 3 3 × **I** 3 3 × 


ˆ
##### F x ( ( ) t, t ) =  0 3 3 ×  A q ( ) ˆ T ω ˆ × (46)



3 3 × 3 3 ×



× ×



ˆ
##### ( ( ) t, t ) =  0 3 3 ×  A q ( ) ˆ T ω ˆ
###   ( )



ˆ
##### ( ) t, t ) =  0 3 3 ×  A q ( ) ˆ T ω ˆ



×



ˆ _T_
#####  A q ( ) 0 3 3 × 

=  
#####  0 3 3 × A q ( ) ˆ T 


##### A q ( ) ˆ ( ) t = 


##### ( ) ˆ



ˆ



ˆ



_T_


##### A q ( ) 0 3 3 × G ( ) t =  0 3 3 × A q ˆ



3 3 ×



(47)



×
_t_ = 

ˆ _T_



3 3 ×



×



According to (A19), the linearized measurement model for multiple vector


observations is given by



ˆ − ˆ −
#### −  ( A q ( ) r ) × A q ( ) 0 3 3 × 

 
= **Hdx** =    
 


ˆ − ˆ −
#### −  ( A q ( ) r ) × A q ( ) 0 3 3 × 



ˆ − ˆ −

**A q** ( ) **r** × **A q**
#### ( )  ( )



ˆ − ˆ
( ) **r** × **A q**



**A q** ( − ) **r** × **A q** − **0**



3 3 ×



− ) **r** × **A q** − **0** ×



  **dx** (48)



**y** = **Hdx** =   **dx**



ˆ − ˆ −

**A q** ( ) **r** × **A q**
#### ( )  ( )



ˆ − ˆ
( ) **r** × **A q**



**A q** ( − ) **r** × **A q** − **0**



3 3 ×



− ) **r** × **A q** − **0** ×


##### Given the above derived state-space model, the  ( ) 3 − EKF with reference frame

attitude error can be readily presented. Since this algorithm possesses similar


procedure with Algorithm 1, it has not been presented here for brevity. Besides the


involved state-space model, the only difference lies in the transformation matrix


estimate equation. Specially, it is updated according to

### χ ˆ k = Ψ ( X ˆ k k − 1 ) exp ( dx ˆ k ^ ) (49)


Denote the error-state **dx** as **dx** ˆ _k_  **dα** ˆ _kT_ **dβ** ˆ _kT_  _T_ . Making use of the first order
=  


approximation of exponential map in (18), (49) can be further approximated as


### ( X ˆ k k − 1 ) ( I 4 4 × + dx ˆ k ^ )


#### χ ˆ k ≈Ψ X ˆ − ( I 4 4 × + dx ˆ



1 **I** 4 4 × + **dx** ˆ _k_ ^



≈Ψ **X** **I** +



_k_ _k k_ − 1 4 4 × _k_



− ×



ˆ ˆ ˆ ˆ ˆ
### =  A q ( k k − 1 )  I 3 3 × + ( dα k × )  β k k − 1 + A q ( k k − 1 ) dβ k 

 **0** 1 3 × 1 



ˆ ˆ ˆ ˆ
### ( k k − 1 )  I 3 3 × + ( dα k × )  β k k − 1 + A q ( k k − 1 )



ˆ ˆ ˆ ˆ ˆ



(50)



**A q** − **I** 3 3 × + **dα** _k_ × **β** − + **A q** − **dβ**



_k k_ − 1 3 3 × _k_ _k k_ − 1 _k k_ − 1 _k_



1 3 3 × _k_ _k k_ − 1 _k k_ − 1



− × − −



**0**



1 3 ×



1



×



If we let



ˆ ˆ ˆ
##### A δq ( k ) =  I 3 3 × + ( dα k × )  =  I 3 3 × − ( δα k × )  (51)


The estimate Lie matrix **X** [ˆ] is given by _k_


ˆ ˆ ˆ ˆ ˆ ˆ
### X k =  A q ( k k − 1 ) A δq ( k ), β k k − 1 + A q ( k k − 1 ) dβ k  (52)

##### It is shown that the  ( ) 3 − EKF with reference attitude error bears much resemblance


to the RIEKF proposed in [19]. The RIEKF is derived via the invariant Kalman filter


theory which has also made use of many Lie group and Lie algebra theories. The


nonlinear error-state is elaborately developed according to the invariance theory in


RIEKF. In contrast, the error-state used here is derived directly from the definition of


transformation matrix error.


Similar with the relationship between the GEKF and MEKF with body frame attitude

##### error, the  ( ) 3 − EKF with reference attitude error can also be viewed as the


geometric algorithm of the traditional MEKF with reference frame attitude error. It


ˆ _T_
##### can be seen from the nonlinear gyroscope bias error definition dβ = A q ( ) ∆ β that,


the linear errors in vectorspace are transformed into the reference frame using the


estimated attitude. This is consistent with the attitude error definition, that is to say, all


the involved errors are expressed in the same estimated reference frame.

##### **5. Conclusions**


In this note, the frame consistent error used in geometric extended Kalman filter has

##### been re-derived using  ( ) 3 formulation of the attitude matrix and gyroscope bias. In this respect, the geometric extended Kalman filter can be viewed as a type of  ( ) 3


based extended Kalman filter for attitude estimation. Moreover, this note has also

##### revealed an interesting link between the  ( ) 3 based extended Kalman filter with


reference attitude error and the right-invariant extended Kalman filter. In the further,


the geometric extended Kalman filter will be further investigated making use of the


##### invariance theory based on the  ( ) 3 perspective. Meanwhile, the  ( ) 3

perspective on geometric extended Kalman filter will also be extended to applications


in inertial navigation.

##### **Appendix: Derivation of the State-Space Model with Reference** **Frame Attitude Error for MEKF**


The multiplicative error quaternion in the reference frame is given by


ˆ 1
**δq** = **q** [−] ⊗ **q** (A1)


Taking the time derivative of (A1) gives



 ˆ − 1 ˆ − 1 
**δq** = **q** ⊗ **q** + **q** ⊗ **q** (A2)


where


 1 1  **ω**
##### q = Ω ( ) ω q =  ⊗ q (A3)

2 2  0

##### The function of Ω ( ) ω is explicitly defined in (A3). According to [13], the time


derivative of inverse quaternion is given by



ˆ

− 1 1 ˆ − 1  **ω**
= − **q** ⊗

2  0



ˆ
ˆ  − 1 1 ˆ − 1 **ω**

**q** = − **q**

2 0



ˆ  − 1 1 ˆ − 1 **ω**

**q** = − **q** ⊗ (A4)



Substituting (A3) and (A4) into (A2), and using the definition of the error quaternion


in (A1) gives



 1 ˆ − 1 **ω** 1 ˆ − 1 **ω**

**δq** = − **q** ⊗  ⊗ **q** + **q** ⊗  ⊗ **q**







ˆ
1 ˆ − 1  **ω** 1 ˆ − 1  **ω**

= − **q** ⊗  ⊗ **q** + **q** ⊗  ⊗

2  0 2  0



ˆ
1 ˆ − 1  **ω** 1 ˆ − 1 **ω**

**q** ⊗  ⊗ **q** + **q** ⊗

2 0 2 0



− −



1 ˆ − 1



1 ˆ − 1  **δω**  1 ˆ − 1  -  **δω** 

= **q** ⊗   ⊗ **q** = **q** ⊗ **q** ⊗ **q** ⊗   ⊗

2  0  2  0 



ˆ − 1  **δω**  1 ˆ − 1 -  **δω** 

**q** ⊗   ⊗ **q** = **q** ⊗ **q** ⊗ **q** ⊗   ⊗ **q**



1 ˆ − 1 **δω** 1 ˆ − 1 
**q** ⊗   ⊗ **q** = **q** ⊗ **q** ⊗ **q** ⊗ 

2 0 2 0



1 ˆ − 1 


(A5)



− −


##### = 1  A q ( ) T δω 

**δq** ⊗ 

2  0 



_T_


##### ( )


##### 1 A q ( )

**δq** ⊗

2  0


##### A q ( ) δω

**δq** ⊗



According to the definition of quaternion multiplication, (A5) can be expanded as


## 1  ( A q ( ) T δω ) × A q ( ) T δω 

=
##### 2 − A q ( ) T δω T 0 
##  ( ) 



_T_
##### A q ( ) δω × A q ( )
## ( )



_T_ _T_


#####  1  A q ( ) δω × A q ( ) δω 

=
##### δq 2 − A q ( ) T δω T 0  δq (A6)



1 
2 − _T_ **δω** _T_ 0



_T_
_T_



_T_
##### A q ( ) δω
## ( )



With small angle approximation assumption, the error quaternion can be


approximated as



 1 **δα** 
=  2 
 1 



1

2

1



**δα**
**δq** =  2  (A7)



Substituting (A7) into (A6) gives


 1 _T_ _T_ ˆ _T_
##### δα = A q ( ) δω × δα + A q ( ) δω ≈ A q ( ) δω (A8)
### 2 ( )


where



ˆ



**δω** = **ω** − **ω**



= −



  ˆ
### ( ω − β − η v ) ( − ω − β )



ˆ



 

**ω** − **β** − **η** − **ω** − **β** (A9)



**ω** − **β** − **η** **v** − **ω** − **β**



= − − − −



**v**


##### ( β η v )



**β** **η**



= −∆+



**v**



Substituting (A9) into (A8) gives


 ˆ _T_
##### δα = − A q ( ) ( ∆+ β η v ) (A10)


_T_
_T_ _T_
##### Denote the error state as ∆ x ( ) t =  δα ∆ β  and the process noise as


_T_
##### w ( ) t  η v ( ) t T η u ( ) t T , the corresponding error model is given by
=  


 ˆ
#### ∆ x ( ) t = F x ( ( ) t, t ) ∆ x ( ) t + G ( ) t w ( ) t (A11)


where



ˆ _T_
#####  0 3 3 × − A q ( ) 

=  
 **0** 3 3 × **0** 3 3 × 



(A12)


(A13)



ˆ _T_
#####  0 3 3 × − A q ( )

_t_ _t_



ˆ
##### ˆ 0 3 3 × − A q ( ) ( ( ) t, t ) = 



ˆ
##### ˆ ( ) t, t =  0 3 3 × − A q


##### F x ( ˆ ( ) t, t ) =  0 3 3 × − A q

 **0** **0**



3 3 × 3 3 ×



× ×



ˆ _T_
##### − A q ( ) 0 3 3 × 

=  
 **0** 3 3 × **I** 3 3 × 



ˆ _T_
##### − A q ( ) 0 3 3 ×

_t_



ˆ
##### − A q ( ) 0 3 3 × ( ) t = 


##### − A q ( ) 0 G ( ) t = 

 **0** **I**



3 3 × 3 3 ×



× ×



The next step involves the determination of the measurement transition matrix used in


MEKF. For a single sensor the true and estimated body vectors are given by

##### b = A q r ( ) (A14)


ˆ − ˆ −
**b** = **A q** **r** (A15)
#### ( )

##### According to (A1), A q ( ) can be obtained by


ˆ
#### A q ( ) = A q ( [−] ) A δq ( ) (A16)

##### where A δq ( can be approximated as ) A δq ( ) = I 3 3 × − ( δα × ) (A17)


Substituting (A16) and (A17) into (A14) and (A15) yields



ˆ − ˆ −


−
#### ( ) A δq r ( ) A q ( )



ˆ − ˆ



− −

**b** **A q** **A δq r** − **A q** **r**



−

∆= **b** −



− −



ˆ − ˆ −
#### ( ) ( I 3 3 × − ( δα × ) ) r − A q ( )



ˆ − ˆ



− −

**A q** **I** 3 3 × − **δα** × **r** − **A q** **r**



− −

**I** 3 3 × − **δα** × **r** − **A q**



= − × **r** −



3 3 ×



ˆ − ˆ −
#### ( ) ( δα × ) r = A q ( ) ( r × )



ˆ − ˆ



**A q** − **δα** × **r** = **A q** − **r** × **δα**



(A18)



− −



= − × **r** = **r** ×



_T_



ˆ − ˆ − ˆ −
#### ( ) ( r × ) ( A q ) A q ( )



ˆ − ˆ − ˆ



**A q** − **r** × **A q** − **A q** − **δα**



− − −



= **r** ×



ˆ −

=  **A q** ( ) **r** ×
####  ( ) 



ˆ − ˆ −

**A q** ( ) **r** × **A q**
#### ( )  ( )



ˆ − ˆ
( ) **r** × **A q**



**A q** ( − ) **r** × **A q** − **δα**



− −



Given the error state definition, the measurement transition matrix for a single sensor


can be given by


ˆ − ˆ −
#### H k =  ( A q ( ) r ) × A q ( ) 0 3 3 ×  (A19)


This matrix can be easily extended to incorporate multiple vector observations.

##### **Acknowledgments**


This work was supported in part by the National Natural Science Foundation of China


(61873275).

##### **References**


[1] Leffens E J, Markley F L, Shuster M D. Kalman filtering for spacecraft attitude


estimation. Journal of Guidance, Control, and Dynamics, 1982, 5(5): 417-429.


[2] Markley F L. Attitude error representations for Kalman filtering. Journal of


guidance, control, and dynamics, 2003, 26(2): 311-317.


[3] Markley F L, Crassidis J L. Fundamentals of spacecraft attitude determination


and control. New York: Springer, 2014.


[4] Crassidis J L, Markley F L, Cheng Y. Survey of nonlinear attitude estimation


methods. Journal of guidance, control, and dynamics, 2007, 30(1): 12-28.


[5] Crassidis J L, Markley F L. Unscented filtering for spacecraft attitude estimation.


Journal of guidance, control, and dynamics, 2003, 26(4): 536-542.


[6] Zhang L, Yang H, Lu H, et al. Cubature Kalman filtering for relative spacecraft


attitude and position estimation. Acta Astronautica, 2014, 105(1): 254-264.


[7] Cao L, Qiao D, Chen X. Laplace ℓ1 Huber based cubature Kalman filter for


attitude estimation of small satellite. Acta Astronautica, 2018, 148: 48-56.


[8] Ahmadi M, Khayatian A, Karimaghaee P. Attitude estimation by divided


difference filter in quaternion space. Acta Astronautica, 2012, 75: 95-107.


[9] Cao L, Li H. Unscented predictive variable structure filter for satellite attitude


estimation with model errors when using low precision sensors. Acta Astronautica,


2016, 127: 505-513.


[10]Huang W, Xie H, Shen C, et al. A robust strong tracking cubature Kalman filter


for spacecraft attitude estimation with quaternion constraint. Acta Astronautica,


2016, 121: 153-163.


[11]Andrle M S, Crassidis J L. Attitude estimation employing common frame error


representations. Journal of Guidance, Control, and Dynamics, 2015, 38(9):


1614-1624.


[12]Whittaker M, Crassidis J L. Inertial navigation employing common frame error


representations. AIAA Guidance, Navigation, and Control Conference. 2017:


1031.


[13]Whittaker M P, Crassidis J L. Linearized analysis of inertial navigation


employing common frame error representations. 2018 AIAA Guidance,


Navigation, and Control Conference. 2018: 1600.


[14]Whittaker M. Inertial Navigation Employing a Common Frame Error Definition.


State University of New York at Buffalo, 2019.


[15]Barrau A. Non-linear state error based extended Kalman filters with applications


to navigation. Mines Paristech, 2015.


[16]Barrau A, Bonnabel S. Intrinsic filtering on Lie groups with applications to


attitude estimation. IEEE Transactions on Automatic Control, 2014, 60(2):


436-449.


[17]Barrau A, Bonnabel S. The invariant extended Kalman filter as a stable observer.


IEEE Transactions on Automatic Control, 2016, 62(4): 1797-1812.


[18]Barrau A, Bonnabel S. An EKF-SLAM algorithm with consistency properties.


arXiv preprint arXiv:1510.06263, 2015.


[19]Gui H, de Ruiter A H J. Quaternion invariant extended kalman filtering for


spacecraft attitude estimation. Journal of Guidance, Control, and Dynamics, 2018,


41(4): 863-878.


[20]Barfoot T D. State estimation for robotics. Cambridge University Press, 2017.


[21]Li M, Mourikis A I. Improving the accuracy of EKF-based visual-inertial


odometry. 2012 IEEE International Conference on Robotics and Automation.


IEEE, 2012: 828-835.


[22]Heo S, Park C G. Consistent EKF-based visual-inertial odometry on matrix Lie


group. IEEE Sensors Journal, 2018, 18(9): 3780-3788.


[23]Wang M, Tayebi A. Hybrid nonlinear observers for inertial navigation using


landmark measurements. IEEE Transactions on Automatic Control, 2020.


[24]Bonnabel S, Barrau A. A Mathematical Framework for IMU Error Propagation


with Applications to Preintegration. IEEE International Conference on Robotics


and Automation (ICRA). 2020.


[25]Gai E, Daly K, Harrison J, et al. Star-sensor-based satellite attitude/attitude rate


estimator. Journal of Guidance, Control, and Dynamics, 1985, 8(5): 560-565.


