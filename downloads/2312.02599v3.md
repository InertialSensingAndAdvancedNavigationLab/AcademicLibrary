1


# MAINS: A Magnetic Field Aided Inertial Navigation System for Indoor Positioning

Chuan Huang, _Student Member, IEEE_, Gustaf Hendeby, _Senior Member, IEEE_, Hassen Fourati, _Senior Member,_
_IEEE_, Christophe Prieur, _Fellow, IEEE_, and Isaac Skog, _Senior Member, IEEE_



_**Abstract**_ **—A Magnetic field Aided Inertial Navigation System**
**(MAINS) for indoor navigation is proposed in this paper. MAINS**
**leverages an array of magnetometers to measure spatial vari-**
**ations in the magnetic field, which are then used to estimate**
**the displacement and orientation changes of the system, thereby**
**aiding the inertial navigation system (INS). Experiments show**
**that MAINS significantly outperforms the stand-alone INS,**
**demonstrating a remarkable two orders of magnitude reduction**
**in position error. Furthermore, when compared to the state-of-**
**the-art magnetic-field-aided navigation approach, the proposed**
**method exhibits slightly improved horizontal position accuracy.**
**On the other hand, it has noticeably larger vertical error on**
**datasets with large magnetic field variations. However, one of**
**the main advantages of MAINS compared to the state-of-the-art**
**is that it enables flexible sensor configurations. The experimental**
**results show that the position error after 2 minutes of navigation**
**in most cases is less than 3 meters when using an array of 30**
**magnetometers. Thus, the proposed navigation solution has the**
**potential to solve one of the key challenges faced with current**
**magnetic-field simultaneous localization and mapping (SLAM)**
**solutions — the very limited allowable length of the exploration**
**phase during which unvisited areas are mapped.**


_**Index Terms**_ **—indoor positioning, magnetic field, error-state**
**Kalman filter, aided navigation**


I. I NTRODUCTION


The outdoor magnetic field is omnipresent, relatively stable,
and almost homogenous. Due to these properties, it has been
used in navigation for a long time, where the magnetic
field is mainly used as a heading reference to correct errors
from integrating noisy gyroscope measurements [1]. However,
those techniques cannot be applied without modifications for
indoor applications because the indoor magnetic field is not
homogenous. An example of the variations in the magnitude
of the magnetic field inside a building is shown in Fig. 1. The
correlation between the position and the magnetic field can
be seen. Therefore, the inhomogeneous magnetic field can be
used as a reliable source for localization in Global Navigation
Satellite System (GNSS) denied environments, such as indoors
or underwater [2]. Indeed, recent years have witnessed many


This work has been funded by the Swedish Research Council (Vetenskapsr˚adet) project 2020-04253 ”Tensor-field based localization”.
Chuan Huang and Gustaf Hendeby are with Dept. of Electrical Engineering,
Link¨oping University, (e-mail: chuan.huang@liu.se; gustaf.hendeby@liu.se).
Hassen Fourati and Christophe Prieur are with the GIPSA-Lab, CNRS,
Inria, Grenoble INP, University Grenoble Alpes, 38000 Grenoble, France (email: hassen.fourati@gipsa-lab.fr; christophe.prieur@gipsa-lab.fr)
Isaac Skog is with Dept. of Electrical Engineering, Uppsala University,
Uppsala, Sweden, and Dept. of Electrical Engineering Link¨oping University,
Link¨oping, Sweden, and the Div. of Underwater Technology, Swedish Defence
Research Agency (FOI), Kista, Sweden (e-mail: isaac.skog@angstrom.uu.se).



Fig. 1. Illustration of the magnetic-field magnitude variations inside a
building. The field near the floor was measured with a magnetometer,
whose location was tracked by camera-based tracking systems. The field
measurement was then interpolated, and the field magnitude was projected
on the floor.


successful applications in magnetic-field-based positioning,
among which the magnetic-field-based SLAM has turned out
to be a promising approach [3]–[5]. It enables the user to
construct a magnetic field map while navigating and having
drift-free positioning, provided revisiting the same region
is possible. However, this technology relies heavily on the
precision of the used odometric information. Otherwise, the
position drift can be significant, making it challenging to reliably recognize the visited place and complete “loop closure”

[6]. For instance, when an inertial navigation system with lowcost inertial sensors is used for doing the odometry, the error
growth rate is typically on the order of 10 meters per minute

[7], which means the system needs to revisit the same region
within a minute to prevent the position drift from becoming
too large to complete loop closure. Therefore, the permissible
length of the exploration phases where new areas are mapped
is extremely limited when using low-cost inertial sensors.
Hence, to increase the usability of current magnetic-field-based
SLAM solutions we need robust odometry techniques that
have a low position drift rate.

With this limitation in mind, the concept of combining
inertial measurements and distributed magnetometry has been
proposed and realized [8]. An array of magnetometers enables


the calculation of the gradients of the magnetic field, from
which the body velocity can be estimated. On the other hand,
the authors in [2] adopted a model-based approach, treating
pose changes in subsequent timestamps as the parameters of
the model to be estimated. The estimated pose change from
the magnetic field measurements can be used to aid an inertial
navigation system to reduce the position growth rate. In this
paper, we present a method for tightly integrated magneticfield-aided inertial navigation. The resulting navigation system has, compared to a pure inertial navigation system, a
significantly reduced error growth rate. Hence, the proposed
navigation method has the potential to greatly extend the
allowable length of the exploration phases in magnetic-fieldbased SLAM systems.


_A. Related Work_


Numerous methods for magnetic-field-based indoor positioning and navigation have been proposed. Current solutions
are roughly categorized into three types: fingerprint-based
methods, magnetic field SLAM, and magnetic field odometry. Fingerprint-based methods [9]–[11] generally rely on a
premeasured magnetic field map to work, which greatly limits
its usability. Therefore, we mainly discuss the latter two types,
which are not constrained by a prior map.
One of the first 2D magnetic field SLAM methods was
proposed in [12], where the magnetic field strength map was
constructed in hierarchical hexagonal tiles of different bin
sizes. To generalize the motions to 3D and cope with the
complexity of representing the map, the authors in [3] selected
a reduced-rank Gaussian process to represent the magnetic
field map and used a Rao-blackwellized particle filter to
estimate both the map and the location of the system. Later, in

[5], the authors successfully achieved drift-free positioning using foot-mounted sensors with similar techniques. To achieve
real-time processing, they used an EKF filter to update the
magnetic field map based on its gradients [4]. Contrary to
the “stochastic” loop closure mechanism in [3]–[5], where it
reduces the uncertainty of the map in the revisited region,
a “deterministic” one was employed in [13], where attitudeinvariant magnetic field information was used to detect loop
closure and constraints on position estimates were formed. The
aforementioned magnetic field SLAM solutions can achieve
drift-free long-term large-scale positioning as long as frequent
loop closure is possible.
Magnetic field odometry, on the other hand, is a lightweight
solution to provide odometric information with a magnetometer array. It does not construct a magnetic field map but
provides odometric information based on local magnetic field
properties. The seminal work [8] derived an equation that
relates the body velocity and the gradient of the magnetic
field, which can be calculated from the measurements from a
set of spatially distributed magnetometers. Later, in [14], [15],
the authors proposed an observer to estimate body velocity,
proved its convergence, and showcased its usability for indoor
localization. In subsequent works [16], [17], the authors incorporated inertial sensor biases and magnetic disturbance in the
model and designed a filter based on the error-state Kalman



2


filter (ESKF). To address the issue of the noisy magnetic
field gradient, the authors in [18], [19] derived a differential
equation for high-order derivatives of the magnetic field. They
then developed a filtering algorithm comprising a primary filter
which is used to estimate the gradient of the field. Later, the
same authors [20], [21] proposed an AI-based solution where
a Long Short-Term Memory (LSTM) model is used to create a
pseudo-measurement of the inertial velocity of the target. The
pseudo-measurement is used to handle adversarial situations
where the states’ observability is affected by the low gradient
of the field and/or the target’s velocity close to zero. The
methods developed have demonstrated promising prospects
in magnetic field odometry. However, they are susceptible to
noise when computing the gradient, and observability issues
arise from a weak magnetic field gradient or low target speed.
To address this problem, [22] matches the waveforms from
a pair of magnetometers in a sliding time window to reduce
the influence of the temporary disappearance of the magnetic
field gradient. Experiments show that the proposed method in

[22] performs similarly to wheel odometry in magnetic-rich
environments.

In a more recent work [23], a polynomial model was
proposed to describe the local magnetic field and to develop a
magnetic field odometry method. Presented experiential results
showed that the model-based odometry approach can give
a higher accuracy at low signal-to-noise ratios, compared
to approaches in [8]. The model-based odometry approach
was further explored in [2], where it was used to estimate
both the translation and orientation change of the array. In
the subsequent work [24], the authors included the magnetic
field model in the state-space description of an INS system
and developed a tightly-integrated magnetic-field-aided INS.
Simulation results showed that it has a much slower drift rate

than stand-alone INS.


_B. Contributions_


The contribution of this work is two-fold. Firstly, it extends
the groundwork laid out in [24] by providing a thorough
derivation and a comprehensive exposition of the proposed
algorithm. Additionally, the performance of the proposed
algorithm using real-world data was assessed and benchmarked against the state-of-the-art. Secondly, we have made
the datasets used in our experiments and the source code
for the proposed algorithm MAINS publicly available, in the
hope that it will facilitate further research within the area of
magnetic-field-based positioning. Both the datasets and the
[source code are available at https://github.com/Huang-Chuan/](https://github.com/Huang-Chuan/MAINSvsMAGEKF)
[MAINSvsMAGEKF.](https://github.com/Huang-Chuan/MAINSvsMAGEKF)


II. S YSTEM M ODELING


Consider the problem of estimating the position and orientation of the sensor platform in Fig. 2, which consists
of an inertial measurement unit (IMU) and an array of 30
magnetometers. To that end, a state-space model will be
presented to realize a tightly-integrated magnetic-field aided
inertial navigation system (INS).


Fig. 2. [The sensor board used in the experiment. It has 30 PNI RM3100](https://www.pnicorp.com/rm3100/)
magnetometers and an Osmium MIMU 4844 IMU mounted on the bottom
side.


_A. Inertial Navigation Equations_


Let the INS navigation state _x_ [ins] _k_ [, the inertial measurements]
_u_ ˜ _k_, and the process noise _w_ _k_ [ins] [be defined as]



 ˜ _s_ ˜ _k_

 _,_ _u_ _k_ ≜ � _ω_ ˜ _k_



3


Here, the subscript _b_ _k_ denotes the body frame at time _k_, and
_R_ _b_ _[n]_ _k_ _[∈]_ [SO][(3)][ denotes the rotation matrix that rotates a vector]
from the _b_ _k_ -frame to the _n_ -frame. Further, _T_ _s_ denotes the
sampling period. Moreover, _s_ _k_ _∈_ R [3] and _ω_ _k_ _∈_ R [3] denote the
specific force and angular velocity, respectively. The vector
_g_ _[n]_ _∈_ R [3] denotes the local gravity. Furthermore, _⊗_ denotes

_·_
quaternion multiplication, and exp _q_ ( ) is the operator that maps
an axis-angle to a quaternion. Lastly, _w_ _k_ [ins] [is modeled as a zero-]
mean white Gaussian noise process with covariance matrix
Σ _w_ _k_ ins = blkdiag(Σ _a_ _,_ Σ _ω_ _,_ Σ _o_ _a_ _,_ Σ _o_ _ω_ ), where Σ ( _·_ ) denotes the
covariance matrix of the corresponding noise component and

_·_
blkdiag( ) is an operator that creates a block diagnal matrix.


_B. Magnetic Field Modeling_


The magnetic field is a three-dimensional vector field whose
properties are described by Maxwell’s equations. Let _M_ ( _r_ ; _µ_ )
be a model of the magnetic field at the location _r ∈_ R [3],
parameterized by the parameter _µ_ . When there is no free
current in the space Ω, _M_ ( _r_ ; _µ_ ) should fulfill


_∇_ _r_ _× M_ ( _r_ ; _µ_ ) = 0 _,_ (3a)


_∇_ _r_ _· M_ ( _r_ ; _µ_ ) = 0 _,_ (3b)


for all _r ∈_ Ω [26].
Equation (3a) guarantees that there exists a scalar potential
function _ϕ_ ( _r_ ; _µ_ ) whose gradient is _M_ ( _r_ ; _µ_ ), i.e.,


_M_ ( _r_ ; _µ_ ) = _∇_ _r_ _ϕ_ ( _r_ ; _µ_ ) _._ (4)


Let _ϕ_ ( _r_ ; _µ_ ) be a polynomial of order ( _l_ +1) in the _r_ component
written as
_ϕ_ ( _r_ ; _µ_ ) = _h_ ( _r_ ) _[⊤]_ _µ_ + _c._ (5)


Here _h_ ( _r_ ) is a vector whose elements are given by the product
_r_ _x_ _[i]_ _[r]_ _y_ _[j]_ _[r]_ _z_ _[k]_ [for] _[ ∀][i, j, k][ ∈]_ [N][, subject to][ 1] _[ ≤]_ _[i]_ [ +] _[ j]_ [ +] _[ k][ ≤]_ _[m]_ [,]
_m_ = 1 _,_ 2 _, · · ·, l_ + 1. Further, _µ ∈_ R _[L]_ is a column vector
of dimension _L_ = ( _l_ + 4)( _l_ + 3)( _l_ + 2) _/_ 6 _−_ 1 and _c_ is
an arbitrary constant that does not affect the gradient of the
potential function. Let Γ( _r_ ) = _∇_ _r_ _h_ ( _r_ ) _[⊤]_, then _M_ ( _r_ ; _µ_ ) can be
written as

_M_ ( _r_ ; _µ_ ) = _∇_ _r_ _ϕ_ ( _r_ ; _µ_ ) = Γ( _r_ ) _µ._ (6)


For the model _M_ ( _r_ ; _µ_ ) to fulfill (3b), the model parameters
_µ_ must be selected so that the following holds



_w_ _k_ _[a]_

 _w_ _k_ _[ω]_

_w_ _k_ _[o]_ _[a]_

 _w_ _k_ _[o]_ _[ω]_





_,_ (1)




ins
_x_ _k_ [≜]



_p_ _[n]_ _k_

 _v_ _k_ _[n]_


_q_ _k_
_o_ _[a]_ _k_

 _o_ _[ω]_ _k_



_,_ and _w_ _k_ ins [≜]
�



respectively. Here, _p_ _[n]_ _k_ _[∈]_ [R] [3] [,] _[ v]_ _k_ _[n]_ _[∈]_ [R] [3] [, and] _[ q]_ _[k]_ _[ ∈]_ [H][ denote]
the position, velocity, and orientation (parameterized as a
unit quaternion) at time _k_, respectively. The superscript _n_
indicates that the vector is represented in the navigation frame.
Moreover, _o_ _[a]_ _k_ _[∈]_ [R] [3] [ and] _[ o]_ _[ω]_ _k_ _[∈]_ [R] [3] [ denote the accelerometer]
and gyroscope bias, respectively. Further, ˜ _s_ _k_ and ˜ _ω_ _k_ denote
the accelerometer and gyroscope measurements, respectively.
Lastly, _w_ _k_ _[a]_ [and] _[ w]_ _k_ _[ω]_ [denote the accelerometer and gyroscope]
measurement noise, respectively, and _w_ _k_ _[o]_ _[a]_ and _w_ _k_ _[o]_ _[ω]_ denote
the random walk process noise for the accelerometer and
gyroscope biases, respectively. For an INS that uses low-cost
sensors and moves at moderate velocities such that the effects

of the transport rate, earth rotation, etc., can be neglected, the
navigation equations are given by [25]


ins ins ins ins
_x_ _k_ +1 [=] _[ f]_ ( _x_ _k_ _[,]_ [ ˜] _[u]_ _[k]_ _[, w]_ _k_ [)] _[,]_ (2a)


where



_∇_ _r_ _·_ Γ( _r_ ) _µ_ = �

_i_ = _x,y,z_



_d_ [Γ( _r_ ) _µ_ ] _i_

= 0 _∀r ∈_ Ω _._ (7)
_dr_ _i_












_,_ (2b)




This constraint can be written as the linear equation system


_Dµ_ = 0 _,_ (8)


where _D_ is a constant matrix derived in [23].
Equations (6) and (8) define the magnetic field model, which
writes as

_M_ ( _r_ ; _µ_ ) = Γ( _r_ ) _µ,_ _Dµ_ = 0 _._ (9)


Finally, _M_ ( _r_ ; _µ_ ) can be reparameterized by introducing the
matrix _D_ _[⊥]_ ≜ null _{D}_ whose columns span the null space
of _D_, and then setting _µ_ = _D_ _[⊥]_ _θ_, where _θ_ is a column



ins ins ins
_f_ ( _x_ _k_ _[,]_ [ ˜] _[u]_ _[k]_ _[, w]_ _k_ [)=]


and



_s_
_p_ _[n]_ _k_ [+] _[ v]_ _k_ _[n]_ _[T]_ _[s]_ [ + (] _[R]_ _b_ _[n]_ _k_ _[s]_ _[k]_ [ +] _[ g]_ _[n]_ [)] _[T]_ 2 [ 2]
_v_ _k_ _[n]_ [+ (] _[R]_ _b_ _[n]_ _k_ _[s]_ _[k]_ [ +] _[ g]_ _[n]_ [)] _[T]_ _[s]_
_q_ _k_ _⊗_ exp _q_ ( _ω_ _k_ _T_ _s_ )
_o_ _[a]_ _k_ [+] _[ w]_ _k_ _[o]_ _[a]_
_o_ _[ω]_ _k_ [+] _[ w]_ _k_ _[o]_ _[ω]_



_s_ _k_ = ˜ _s_ _k_ _−_ _o_ _[a]_ _k_ _[−]_ _[w]_ _k_ _[a]_ _[,]_ (2c)


_ω_ _k_ = ˜ _ω_ _k_ _−_ _o_ _[ω]_ _k_ _[−]_ _[w]_ _k_ _[ω]_ _[.]_ (2d)


4



vector of dimension equal to that of the null space of _D_ . The
reparameterized model is given by


_M_ ( _r_ ; _θ_ ) = Φ( _r_ ) _θ,_ (10)


where Φ( _r_ ) ≜ Γ( _r_ ) _D_ _[⊥]_ _∈_ R [3] _[×][κ]_ is the regression matrix
defined in [23] and _θ ∈_ R _[κ]_ is the coefficient of the polynomial
model; for a _l_ [th] order polynomial the model has _κ_ = dim( _θ_ ) =
_l_ [2] +4 _l_ +3 unknown parameters [2] [1] . Note that the model (10)
can be defined in either the body frame or navigation frame.
Within this paper, it will be defined in the body frame. Next,
a procedure for transforming the model from body frame _α_ to
body frame _β_ will be presented.


_C. Tranforming models between body frames_


Let the magnetic field model (10) be associated with the
body frame, which means _M_ ( _r_ ; _θ_ ) accepts locations _r_ expressed in the current body frame and outputs magnetic field
vector in the same frame. Then the magnetic field can be
represented in the two body frames _α_ and _β_, i.e.,


_M_ _[α]_ ( _r_ _[α]_ ; _θ_ _[α]_ ) = Φ( _r_ _[α]_ ) _θ_ _[α]_ _,_

(11)
_M_ _[β]_ ( _r_ _[β]_ ; _θ_ _[β]_ ) = Φ( _r_ _[β]_ ) _θ_ _[β]_ _._


Here the superscripts on _M_ and _r_ denote the corresponding
body frame in which they are resolved and the superscript
on _θ_ denotes the frame with which the model coefficients are
associated.

By expressing the magnetic field vector at a given location
with the two models and aligning them in the same frame, the
two models can be related as


_M_ _[β]_ ( _r_ _[β]_ ; _θ_ _[β]_ ) = _R_ _α_ _[β]_ _[M]_ _[ α]_ [(] _[r]_ _[α]_ [;] _[ θ]_ _[α]_ [)] _[,]_ (12a)


where
_r_ _[α]_ = ( _R_ _α_ _[β]_ [)] _[⊤]_ _[r]_ _[β]_ [ + ∆] _[p]_ _[α]_ _[.]_ (12b)


Here ∆ _p_ _[α]_ denotes the translation vector expressed in body
frame _α_ . An illustration of the geometric relationship between
the two frames and the magnetic field vector is shown in Fig. 3.
Now consider transforming the magnetic field model from
body frame _b_ _k_ to _b_ _k_ +1 . Let the relative body frame change be
encoded by







magnetic field vector











Fig. 3. A 2D illustration of the geometric relationship between the body
frames at two consecutive times. The applicable region Ω of the magnetic
field model at time _k_ is in blue, and the black dot indicates the location where
the two models output the corresponding magnetic field in their coordinate
frames.



∆ _p_ _[b]_ _k_ _[k]_ [=] _[ R]_ _b_ _[n]_ _k_ _[⊤]_ � _v_ _k_ _[n]_ _[T]_ _[s]_ [+ (] _[R]_ _b_ _[n]_ _k_ _[s]_ _[k]_ [+] _[ g]_ _[n]_ [)] _[T]_ 2 [ 2] _s_



_._ (15b)
�



Here ∆ _ϕ_ _k_ = _ω_ _k_ _T_ _s_ and [ _·_ ] _×_ is an operator that maps a vector
in R [3] to a skew-symmetric matrix such that [ _a_ ] _×_ _b_ = _a × b_ .
Next, substituting the generic magnetic model in (14) with
the proposed polynomial model (10) yields the equality


Φ( _r_ _[b]_ _[k]_ [+1] ) _θ_ _k_ +1 = _R_ _b_ _[b]_ _k_ _[k]_ [+1] Φ( _r_ _[b]_ _[k]_ ) _θ_ _k_ _._ (16)


Note that for a given _{r_ _[b]_ _[k]_ [+1] _, θ_ _k_ _, ψ_ _k_ _}_, (16) represents 3
linear equations. Since _θ_ _k_ +1 is of dimension _κ_, which is
greater than 3, it is necessary to use more than one location
vector _r_ to solve the equation system. In general, _S_ = _⌈κ/_ 3 _⌉_
location vectors can be used to construct the equation system


_Aθ_ _k_ +1 = _B_ ( _ψ_ _k_ ) _θ_ _k_ _,_ (17a)


where



 _._ (17b)







 _,_ _B_ ( _ψ_ _k_ ) =







∆ _p_ _[b]_ _k_ _[k]_
_ψ_ _k_ =
� ∆ _ϕ_ _k_



_,_ (13)
�









_R_ _b_ _[b]_ _k_ _[k]_ [+1] Φ( _r_ 1 _[b]_ _[k]_ [)]

...
_R_ _b_ _[b]_ _k_ _[k]_ [+1] Φ( _r_ _S_ _[b]_ _[k]_ [)]



_A_ =









Φ( _r_ 1 _[b]_ _[k]_ [+1] )

...
Φ( _r_ _S_ _[b]_ _[k]_ [+1] )



where ∆ _p_ _[b]_ _k_ _[k]_ _[∈]_ [R] [3] [ and][ ∆] _[ϕ]_ _[k]_ _[ ∈]_ [[0] _[,]_ [ 2] _[π]_ []] [3] [ denote the translation]
and orientation change from the body frame _b_ _k_ to _b_ _k_ +1, respectively. Replacing _α_ and _β_ with _b_ _k_ and _b_ _k_ +1 respectively and
using _θ_ _k_ and _θ_ _k_ +1 to denote the corresponding coefficients,
the following holds

_M_ _[b]_ _[k]_ [+1] ( _r_ _[b]_ _[k]_ [+1] ; _θ_ _k_ +1 ) = _R_ _b_ _[b]_ _k_ _[k]_ [+1] _M_ _[b]_ _[k]_ ( _r_ _[b]_ _[k]_ ; _θ_ _k_ ) _,_ (14a)


where
_r_ _[b]_ _[k]_ = ( _R_ _b_ _[b]_ _k_ _[k]_ [+1] ) _[⊤]_ _r_ _[b]_ _[k]_ [+1] + ∆ _p_ _[b]_ _k_ _[k]_ _[.]_ (14b)

The rotation matrix _R_ _b_ _[b]_ _k_ _[k]_ [+1] and translation ∆ _p_ _[b]_ _k_ _[k]_ [are given by]


_⊤_
_R_ _b_ _[b]_ _k_ _[k]_ [+1] = �exp([∆ _ϕ_ _k_ ] _×_ )� _,_ (15a)


1 An example of the 1st order model used in the experiment is provided in
the appendix.



If the vectors _r_ 1 _[b]_ _[k]_ [+1] _, · · ·, r_ _S_ _[b]_ _[k]_ [+1] can be chosen such that _A_
has full column rank, it holds that


_θ_ _k_ +1 = _A_ _[†]_ _B_ ( _ψ_ _k_ ) _θ_ _k_ _,_ (18)


where _A_ _[†]_ denotes the Moore–Penrose inverse of _A_ .

Since the magnetic field model should describe the magnetic
field locally, the update in (18), which with time implicitly
expands the applicable space Ω of the model, will inevitably
introduce modeling errors. To account for those errors, with
a slight abuse of notation, the update of the polynomial
coefficients of the magnetic field as the body frame change
is modeled as


_θ_ _k_ +1 = _f_ _[θ]_ ( _θ_ _k_ _, x_ ins _k_ _[,]_ [ ˜] _[u]_ _[k]_ _[, w]_ _k_ ins _[, w]_ _k_ _[θ]_ [)] _[,]_ (19)


5



where


_f_ _[θ]_ ( _θ_ _k_ _, x_ ins _k_ _[,]_ [ ˜] _[u]_ _[k]_ _[, w]_ _k_ ins _[, w]_ _k_ _[θ]_ [) =] _[ A]_ _[†]_ _[B]_ [(] _[ψ]_ _[k]_ [)] _[θ]_ _[k]_ [+] _[ w]_ _k_ _[θ]_ _[.]_ (20)


Here _w_ _k_ _[θ]_ [is assumed to be a white Gaussian noise process]
with zero mean and covariance matrix Σ _θ_ . Note that _ψ_ _k_ is a
function of _x_ [ins] _k_ [,][ ˜] _[u]_ _[k]_ [, and] _[ w]_ _k_ [ins] [.]


_D. Magnetometer Array Measurement Model_


Given the magnetic field model in (10), the measurement
_y_ _k_ [(] _[i]_ [)] _∈_ R [3] from the _i_ [th] sensor in the magnetometer array at
time _k_ can be modeled as


_y_ _k_ [(] _[i]_ [)] = Φ( _r_ _m_ _i_ ) _θ_ _k_ + _e_ _k_ [(] _[i]_ [)] _[,]_ (21)


where _r_ _m_ _i_ _∈_ R [3] denotes the location of the _i_ [th] magnetometer
in the array. Further, _e_ _k_ [(] _[i]_ [)] _∈_ R [3] denotes the measurement error,
which includes both the measurement noise and the imperfections of the magnetic-field model. The error is assumed to be
white and Gaussian distributed with covariance matrix Σ _e_ ( _ki_ ) [.]


_E. Complete System_


Given the presented navigation equations and the magneticfield model, the dynamics and observations of the full system
can be described by the following state-space model.
Let the state vector _x_ _k_, the process noise vector _w_ _k_, and
the measurement noise _e_ _k_ be defined as













_,_ (22)




Fig. 4. The flowchart of the state estimation algorithm.


III. S TATE E STIMATION


The quaternion _q_ _k_ in the state vector does not belong to Euclidean space. Therefore, standard nonlinear filter algorithms,
such as the extended Kalman filter and unscented Kalman
filter, cannot be applied to the state-space model in (23)
without appropriate modifications. The error state Kalman
filter (ESKF) presented in [25] circumvents the problem by the
use of “error quaternion”, which is a small perturbation around
the “estimated quaternion” expressed in R [3] . With reference
to Fig. 4, the algorithm works by propagating an estimated
state ˆ _x_ _k_ via the state transition model in (23a) and using a
complementary Kalman filter to estimate the error state _δx_ _k_,
which is then used to correct the estimated state ˆ _x_ _k_ . Since
the ESKF is a standard algorithm, only the error propagation
model that is unique to the state-space model in (23), will here
be derived.


_A. Error State Definition_


The error state _δx_ _k_ is defined as



_,_ and _e_ _k_ ≜
�



_e_ [(1)] _k_



...

 _e_ [(] _k_ _[N]_ [)]



_x_ ins _k_
_x_ _k_ ≜ � _θ_ _k_



_w_ _k_ ins
� _,_ _w_ _k_ ≜ � _w_ _k_ _[θ]_



respectively. Combining the models in (2), (19), and (21) gives
the state-space model


_x_ _k_ +1 = _f_ ( _x_ _k_ _,_ ˜ _u_ _k_ _, w_ _k_ ) _,_ (23a)


_y_ _k_ = _Hx_ _k_ + _e_ _k_ _,_ (23b)


where

_f_ ( _x_ _k_ _,_ ˜ _u_ _k_ _, w_ _k_ ) = _f_ ins ( _x_ ins _k_ _[,]_ [ ˜] _[u]_ _[k]_ _[, w]_ _k_ [ins] [)] _,_ (23c)
� _f_ _[θ]_ ( _θ_ _k_ _, x_ [ins] _k_ _[,]_ [ ˜] _[u]_ _[k]_ _[, w]_ _k_ _[θ]_ [)] �


and



_δx_ _k_ ≜ � _δxδθ_ ins _kk_






_._ (24)




and _δx_ ins _k_ [=]
�









_δp_ _[n]_ _k_
_δv_ _k_ _[n]_

_ϵ_ _k_
_δo_ _[a]_ _k_
_δo_ _[ω]_ _k_







 _._ (23d)



_H_ =









0 3 _×_ 16 Φ( _r_ _m_ 1 )

... ...
0 3 _×_ 16 Φ( _r_ _m_ _N_ )



Here, the process noise covariance _Q_ _k_ and the measurement
noise covariance _R_ _k_ are


_Q_ _k_ ≜ **Cov** ( _w_ _k_ ) = blkdiag(Σ _a_ _,_ Σ _ω_ _,_ Σ _o_ _a_ _,_ Σ _o_ _ω_ _,_ Σ _θ_ ) _,_ (23e)

_R_ _k_ ≜ **Cov** ( _e_ _k_ ) = blkdiag(Σ _e_ (1) _k_ _[,]_ [ Σ] _[e]_ [(2)] _k_ _[,][ · · ·][,]_ [ Σ] _[e]_ [(] _k_ _[N]_ [)] ) _,_ (23f)


respectively.



Here, for the position, velocity, sensor biases, and magnetic
field model parameters, the standard additive error definition is
used (e.g., _δp_ _[n]_ _k_ [=] _[ p]_ _[n]_ _k_ _[−]_ _[p]_ [ˆ] _[n]_ _k_ [). On the other hand, the orientation]
error _ϵ_ _k_ _∈_ R [3] satisfies the equation _R_ _b_ _[n]_ _k_ _[≃]_ _[R]_ [ˆ] _b_ _[n]_ _k_ [(] _[I]_ [3] [ + [] _[ϵ]_ _[k]_ []] _[×]_ [)][.]
The true state _x_ _k_ and the estimated state ˆ _x_ _k_ relate to each

other via


_x_ _k_ = ˆ _x_ _k_ _⊕_ _δx_ _k_ _,_ (25)


where the operator _⊕_ is defined by


_p_ _[n]_ _k_ [= ˆ] _[p]_ _[n]_ _k_ [+] _[ δp]_ _[n]_ _k_ _[,]_ (26a)


_v_ _k_ _[n]_ [= ˆ] _[v]_ _k_ _[n]_ [+] _[ δv]_ _k_ _[n]_ _[,]_ (26b)


1
_q_ _k_ = ˆ _q_ _k_ _⊗_ [1 2 _[ϵ]_ _k_ _[⊤]_ []] _[⊤]_ _[,]_ (26c)

_o_ _[a]_ _k_ [= ˆ] _[o]_ _[a]_ _k_ [+] _[ δo]_ _[a]_ _k_ _[,]_ (26d)


_o_ _[ω]_ _k_ [= ˆ] _[o]_ _[ω]_ _k_ [+] _[ δo]_ _[ω]_ _k_ _[,]_ (26e)

_θ_ _k_ = _θ_ [ˆ] _k_ + _δθ_ _k_ _._ (26f)


_B. Inertial Error State Dynamics_


The dynamics of _δx_ [ins] _k_ [has been derived in [25] and are given]
by
_δx_ ins _k_ +1 [=] _[ F]_ _k_ ins _[δx]_ ins _k_ [+] _[ G]_ ins _k_ _[w]_ _k_ ins _[,]_ (27a)


where



6


Here, the second and higher-order error terms have been
neglected. Moreover, it holds that

_δϕ_ _k_ = ∆ _ϕ_ _k_ _−_ ∆ _ϕ_ [ˆ] _k_ = _−_ ( _δo_ _[ω]_ _k_ [+] _[ w]_ _k_ _[ω]_ [)] _[T]_ _[s]_ _[.]_ (31)


Bringing it all together gives the following expression for
the magnetic field subsystem error state propagation



_w_ _k_ ins
� _w_ _k_ _[θ]_



_δθ_ _k_ +1 = _F_ _k_ _[θ]_ _[δ][x]_ [ˆ] _[k]_ [+] _[ G]_ _[θ]_ _k_



_,_ (32a)
�



0 0 0 0 0 _I_ _κ_

ˆ

0 _R_ _n_ _[b]_ _k_ _[T]_ _[s]_ [[] _[η]_ [( ˆ] _[R]_ _n_ _[b]_ _[k]_ _[,]_ [ ˆ] _[v]_ _k_ _[n]_ [)]] _[×]_ [ 0] 0 0

0 0 0 0 _−I_ 3 _T_ _s_ 0



_F_ _k_ _[θ]_ [=] _[ A]_ _[†]_ [ �] _B_ ( _ψ_ [ˆ] _k_ ) _J_ 1 _J_ 2 � _C_ (ˆ _x_ _k_ ) _,_ (32b)

_G_ _[θ]_ _k_ [=] �0 _−_ _A_ _[†]_ _J_ 2 _T_ _s_ 0 0 _I_ _κ_ � _._ (32c)






_,_ (27b)




where


Here,


and


_C_ (ˆ _x_ _k_ )=



_d_
_J_ 1 =
_d_ ∆ _p_ _k_

_d_
_J_ 2 =
_d_ ∆ _ϕ_ _k_



� _B_ ( _ψ_ [ˆ] _k_ ) _θ_ _k_ � _,_ (32d)


� _B_ ( _ψ_ [ˆ] _k_ ) _θ_ _k_ � _,_ (32e)



_F_ _k_ ins [=]



_I_ 3 _I_ 3 _T_ _s_ 0 0 0

 0 _I_ 3 _−R_ [ˆ] _b_ _[n]_ _k_ [[ˆ] _[s]_ _[k]_ []] _[×]_ _[T]_ _[s]_ _[ −][R]_ [ˆ] _b_ _[n]_ _k_ _[T]_ _[s]_ 0

0 0 exp([∆ _ϕ_ [ˆ] _k_ ] _×_ ) _[⊤]_ 0 _−I_ 3 _T_ _s_
0 0 0 _I_ 3 0

 0 0 0 0 _I_ 3



 _._ (32f)





Combining (27) and (32) gives the complete state-space model
of the error state, i.e.,


_δx_ _k_ +1 = _F_ _k_ _δx_ _k_ + _G_ _k_ _w_ _k_ _,_ (33a)


_δy_ _k_ = _H_ _δx_ _δx_ _k_ + _e_ _k_ _,_ (33b)



where
_F_ _k_ = � _F_ ins _k_ _F_ _k_ _[θ]_ 0






_._ (27c)









_G_ ins _k_ [=]









0 0 0 0
_R_ ˆ _b_ _[n]_ _k_ _[T]_ _[s]_ 0 0 0
0 _I_ 3 _T_ _s_ 0 0
0 0 _I_ 3 _√T_ _s_ 0
0 0 0 _I_ 3 _√T_ _s_



� _,_ _G_ _k_ = � _G_ ins _k_ _G_ _[θ]_ _k_ 0� _,_ (33c)



Here, ˆ _s_ _k_ = ˜ _s_ _k_ _−_ _o_ ˆ _[a]_ _k_ [and][ ∆ˆ] _[ϕ]_ _[k]_ [ = (˜] _[ω]_ _[k]_ _[ −]_ _[o]_ [ˆ] _[ω]_ _k_ [)] _[T]_ _[s]_ [.]


_C. Magnetic Field Subsystem Error State Dynamics_


To the first order, the errors in (19) propagate according to







_H_ _δx_ =









0 3 _×_ 15 Φ( _r_ _m_ 1 )

... ...
0 3 _×_ 15 Φ( _r_ _m_ _N_ )



 _._ (33d)



_δθ_ _k_ +1 = _A_ _[†]_ [ �] _B_ ( _ψ_ [ˆ] _k_ ) _dψd_ _k_ � _B_ ( _ψ_ [ˆ] _k_ ) _θ_ _k_ � [��] _δψδθ_ _kk_ � + _w_ _k_ _[θ]_ _[,]_ [ (28a)]


where


_δψ_ _k_ = _ψ_ _k_ _−_ _ψ_ [ˆ] _k_ _._ (28b)


However, instead of expressing the error development in terms
of _δψ_ _k_, we would like to express it in terms of the orientation
error _ϵ_ _k_, velocity error _δv_ _k_ _[n]_ [, accelerometer bias estimation]
error _δo_ _[a]_ _k_ [, and gyroscope bias estimation error] _[ δo]_ _[ω]_ _k_ [. To do]
so, note that from (15b) we have


∆ˆ _p_ _[b]_ _k_ _[k]_ [= ˆ] _[R]_ _n_ _[b]_ _[k]_ _[T]_ _[s]_ [(ˆ] _[v]_ _k_ _[n]_ [+] _[ g]_ _[n]_ _[T]_ _[s]_ _[/]_ [2) + ˆ] _[s]_ _[k]_ _[T]_ [ 2] _s_ _[/]_ [2] _[,]_ (29a)


where
_R_ ˆ _n_ _[b]_ _[k]_ [= (] _[I]_ [3] _[−]_ [[] _[ϵ]_ _[k]_ []] _[×]_ [)] _[−]_ [1] _[R]_ _n_ _[b]_ _[k]_ _[,]_ (29b)


which gives that


_δ_ ∆ _p_ _k_ =∆ _p_ _[b]_ _k_ _[k]_ _[−]_ [∆ˆ] _[p]_ _[b]_ _k_ _[k]_
_≈−_ [ _ϵ_ _k_ ] _×_ _R_ [ˆ] _n_ _[b]_ _[k]_ _[T]_ _[s]_ [(ˆ] _[v]_ _k_ _[n]_ [+] _[ g]_ _[n]_ _[T]_ _[s]_ _[/]_ [2) + ˆ] _[R]_ _n_ _[b]_ _[k]_ _[δv]_ _k_ _[n]_ _[T]_ _[s]_

(30)

=[ _R_ [ˆ] _n_ _[b]_ _[k]_ _[T]_ _[s]_ [(ˆ] _[v]_ _k_ _[n]_ [+] _[ g]_ _[n]_ _[T]_ _[s]_ _[/]_ [2)] ] _×_ _ϵ_ _k_ + _R_ [ˆ] _n_ _[b]_ _[k]_ _[δv]_ _k_ _[n]_ _[T]_ _[s]_ _[.]_
� ~~��~~ ~~�~~

_η_ ( _R_ [ˆ] _nbk_ _[,][v]_ [ˆ] _k_ _[n]_ [)]



Here _δy_ _k_ ≜ _y_ _k_ _−_ _Hx_ ˆ _k_ .
The Kalman filter can be applied to (33) to estimate the error
state, which is then used to correct the estimated state. The
complete description of the proposed ESKF is summarized in
Algorithm 1.


_D. Adaptation of the measurement noise covariance_

As previously mentioned, the polynomial magnetic field
model is not perfect. The model imperfections will vary with
the complexity of the magnetic field and the covariance _R_ _k_
should vary accordingly. One possibility to make _R_ _k_ adapt to
the complexity of the field is to assume _R_ _k_ = _σ_ _k_ [2] _[I]_ [3] _[N]_ [ and then]
fit the magnetic-field model to the current observations _y_ _k_ and
estimate _σ_ _k_ [2] [from the residual. That is,] _[ σ]_ _k_ [2] [is estimated as [27],]

_σ_ ˆ _k_ [2] [=] 31 _N_ _[∥]_ [(] _[I]_ [3] _[N]_ _[ −]_ _[XX]_ _[†]_ [)] _[y]_ _[k]_ _[∥]_ [2] _[,]_ (34a)


where _X_ is given by







 _._ (34b)



_X_ =









Φ( _r_ _m_ 1 )

...
Φ( _r_ _m_ _N_ )


**Algorithm 1** ESKF algorithm
**Input:** _{u_ ˜ _k_ _, y_ _k_ _}_ _[N]_ _k_ =0
**Output:** _{x_ ˆ _k|k_ _, P_ _k|k_ _}_ _[N]_ _k_ =1
_Initialisation_ : estimated state ˆ _x_ 0 _|_ 0, covariance matrix _P_ 0 _|_ 0
**For** _k_ = 0 to _N −_ 1 do


**State propagation**

_x_ ˆ _k_ +1 _|k_ _←_ _f_ (ˆ _x_ _k|k_ _,_ ˜ _u_ _k_ _,_ 0)
**Error state uncertainty propagation**
_P_ _k_ +1 _|k_ _←_ _F_ _k_ _P_ _k|k_ _F_ _k_ _[⊤]_ [+] _[ G]_ _[k]_ _[Q]_ _[k]_ _[G]_ _[⊤]_

**Error state observation**

_z_ _k_ +1 _←_ _y_ _k_ +1 _−_ _Hx_ ˆ _k_ +1
_S_ _k_ +1 _←_ _HP_ _k_ +1 _|k_ _H_ _[⊤]_ + _R_ _k_ +1
_Kδx_ ˆ _kk_ +1+1 _← ←PK_ _kk_ +1+1 _|k_ _zH_ _k_ +1 _[⊤]_ _S_ _k_ _[−]_ +1 [1]
_P_ _k_ +1 _|k_ +1 _←_ _P_ _k_ +1 _|k_ _−_ _K_ _k_ +1 _HP_ _k_ +1 _|k_
**Correct the estimated state**

_x_ ˆ _k_ +1 _|k_ +1 _←_ _x_ ˆ _k_ +1 _|k_ _⊕_ _δx_ ˆ _k_ +1
**ESKF reset**
_δx_ ˆ _k_ +1 _←_ 0
**end for**


IV. E XPERIMENTAL R ESULTS


To evaluate the proposed method multiple experiments were
conducted using the array in Fig. 2. In each experiment, the
magnetometer array was first sitting still on the ground for
a few seconds and then picked up by a person. The person
then held it in his/her hands and walked in squares for a few
laps before putting the board back on the ground. The true
trajectory of the array was measured using a camera-based
motion-tracking system. In total 8 datasets were recorded. The
main characteristics of the different datasets are summarized

in Table I.

The datasets were processed with three algorithms: a standalone INS; the proposed MAINS, and the method proposed
in [19]. The positions measured by the motion-tracking system
were first made available to all algorithms for 60 seconds to
calibrate IMU biases and stabilize state estimates. Then all

systems operated without position aiding for the rest trajectory.
This is similar to the scenario of a user coming into a building
where GNSS signals are lost. Since the method in [19] by
default is designed to use 5 magnetometers, the same sensor
configuration (the left in Fig. 5) as in [19] was used when
comparing the two algorithms; only the performance during
the non-position-aiding part of the trajectory was evaluated.
An example of the estimated trajectories estimated by the
three algorithms and the corresponding positional errors are
plotted in Fig. 6. Since MAINS supports using other sensor
configurations than the square configuration, the performance
of the proposed algorithm was also evaluated using all the
sensors in the array (see Fig. 5). An example of the trajectory
estimated when using all sensors is shown in Fig. 7. The
results, in terms of root mean square (RMS) position and
velocity errors, from processing all 8 datasets with the different
sensor configurations and algorithms are summarized in Table
II. The position errors at the end of the trajectories are also
shown.



Fig. 5. Sensor configurations used in the experiments. Left: Square configuration. Right: Rectangular configuration.


It can be seen from Fig. 6 that both MAINS and the
method in [19] output a trajectory with a similar shape as
the true trajectory, while the INS trajectory quickly drifted
away. The same conclusion can be drawn from the horizontal
and vertical error plots. As expected the position error of
the INS grows much faster than those of the other two
methods. Looking at the results in Tab. II, it shows that both
MAINS and the method [19] achieved superior performance
in terms of horizontal error, vertical error, and speed error,
compared to the stand-alone INS. However, MAINS has a
consistently lower speed error than the method [19] on all
datasets. Furthermore, MAINS has, in general, a lower average
horizontal error, which is consistent with the observation of
the trajectory shown in Fig. 6. In terms of vertical error, the
method [19] performed poorly on the datasets where the board
was tilted, while MAINS had larger errors on the datasets
where the board was close to the ground. The reason for [19]
performing worse is that when the board is tilted (so is the
body frame), the speed errors in all three axes contributed
to a larger vertical error, compared to the case when the
board is flat and the vertical error comes mostly from the
speed error in the z-axis. Meanwhile, the reason why MAINS
produced trajectories with a large vertical drift when the board
was close to the ground is that the magnetic field there was
too complex for the polynomial model, which results in large
fitting residuals and thus large innovations in filtering pulling
the estimate away from what it should be. Comparing the
performance of the MAINS algorithm with the two different
sensor configurations, the benefit of using more sensors is
apparent — Vertical error was significantly reduced, and both
the horizontal and vertical error at the end of the trajectory
were less than 3 meters for most trajectories.
To help readers better understand the magnetic field in
which the experiments were conducted and the full potential of
MAINS, the trajectory estimated by MAINS with rectangular
sensor configuration is plotted on top of a magnetic field
magnitude plot, as shown in Fig. 7. It can be seen that
the magnitude variance along the trajectory is around 8 _µ_ T,
and the gradient varies. MAINS is capable of producing
a trajectory that is very close to the true one, and more
importantly, the positional error is consistently reflected by the
uncertainty. One thing that may raise readers’ interest is why
the trajectory seems to always “bend inwards” near the top



**Square configuration**


-0.1


0


0.1


-0.2 -0.1 0 0.1 0.2

x-axis [m]



7


**Rectangular configuration**


-0.1


0


0.1


-0.2 -0.1 0 0.1 0.2

x-axis [m]




8



TABLE I

I NFORMATION ABOUT THE DATASETS


Data sequence **LP-1** **LP-2** **LP-3** **NP-1** **NP-2** **NP-3** **NT-1** **NT-2**
Trajectory length ~~[*]~~ (m) 138.72 167.07 194.41 136.23 134.66 137.76 164.62 137.87
Trajectory duration [*] (s) 272 286 332 177 165 154 185 151
Average height (m) 0.49 0.52 0.55 0.85 0.84 0.79 0.73 0.74
Board orientation relative to the ground parallel parallel parallel parallel parallel parallel tilted tilted


- including the initial part of the trajectory where the position-aiding is turned on.
LP: low height and parallel NP: normal height and parallel NT: normal height and tilted.



**Horizontal trajectory**



10





5


0


-5


-10

|Col1|Col2|True trajector|Col4|Col5|
|---|---|---|---|---|
|||True trajector|True trajector|y|
|||INS trajector<br>MAINS traje<br>Trajectory fro|INS trajector<br>MAINS traje<br>Trajectory fro|y<br>ctory<br>m [19]|
|||INS trajector<br>MAINS traje<br>Trajectory fro|INS trajector<br>MAINS traje<br>Trajectory fro||
||||||
||||||
||||||
||||||



-10 -5 0 5 10

x [m]


**Horizontal error**


10 [0]


10 [-5]


0 20 40 60 80 100 120 140 160 180

time [s]


**Vertical error**


10 [0]


10 [-5]


0 20 40 60 80 100 120 140 160 180

time [s]


Fig. 6. Estimated trajectory and the corresponding positional errors from a
stand-alone INS, MAINS, and the method proposed in [19]. The square sensor
configuration was used in this experiment.


left corner. We cannot offer a precise explanation now, but
one of the possibilities is that MAINS is sensitive to errors
in magnetometer calibration parameters, which are difficult to
eliminate.


V. C ONCLUSION AND F UTURE W ORK


The results presented in this paper demonstrate the effectiveness of the MAINS algorithm for magnetic-field-based
indoor positioning. The proposed algorithm outperforms the
stand-alone INS in terms of horizontal and vertical error,
as well as speed error. Furthermore, it has a comparable
performance with the state-of-the-art method with the same
sensor configuration. Having the advantage of being flexible
with sensor configurations, the MAINS algorithm can, in most
cases, limit the position drift to less than 3 meters after 2
minutes of navigation when using all magnetometers.



Future work could focus on investigating loop closure
detection mechanisms for magnetic field SLAM, unifying
sensor calibration and parameter tuning within the MAINS
framework, and exploring the impact of the magnetic field
model on positioning error. Overall, the MAINS algorithm
shows great promise for real-life applications of magneticfield-based positioning.


R EFERENCES


[1] C.-I. Chesneau, “Magneto-inertial dead-reckoning in inhomogeneous
field and indoor applications,” Ph.D. dissertation, Universit´e Grenoble
Alpes, 2018.

[2] I. Skog, G. Hendeby, and F. Trulsson, “Magnetic-field based odometry
– an optical flow inspired approach,” in _Int. Conf. on Indoor Positioning_
_and Indoor Navigation (IPIN)_, Lloret de Mar, Spain, Nov. 2021, pp.
1–8.

[3] M. Kok and A. Solin, “Scalable magnetic field SLAM in 3D using
gaussian process maps,” in _Proc. 2018 21st Int. Conf. on Information_
_Fusion (FUSION)_, Cambridge, United Kingdom, July 2018, pp. 1353–
1360.

[4] F. Viset, R. Helmons, and M. Kok, “An extended Kalman filter for
magnetic field slam using gaussian process regression,” _Sensors_, vol. 22,
no. 8, 2022.

[5] F. Viset, J. T. Gravdahl, and M. Kok, “Magnetic field norm SLAM using
Gaussian process regression in foot-mounted sensors,” in _European_
_Control Conference (ECC)_, Rotterdam, Netherlands, June 2021, pp.
392–398.

[6] S. Thrun, W. Burgard, and D. Fox, _Probabilistic robotics_ . Cambridge,
Mass.: MIT Press, 2005.

[7] J.-O. Nilsson and I. Skog, “Inertial sensor arrays — a literature review,”
in _Proc. 2016 European Navigation Conference (ENC)_, Helsinki, Finland, May 2016, pp. 1–10.

[8] D. Vissiere, A. Martin, and N. Petit, “Using distributed magnetometers
to increase imu-based velocity estimation into perturbed area,” in _Proc._
_2007 46th IEEE Conference on Decision and Control_, New Orleans,
LA, USA, Dec. 2007, pp. 4924–4931.

[9] L.-F. Shi, B.-L. Feng, Y.-F. Dai, G.-X. Liu, and Y. Shi, “Pedestrian
indoor localization method based on integrated particle filter,” _IEEE_
_Transactions on Instrumentation and Measurement_, vol. 72, pp. 1–10,
2023.

[10] H. Liu, H. Xue, L. Zhao, D. Chen, Z. Peng, and G. Zhang, “Magloc-ar:
Magnetic-based localization for visual-free augmented reality in largescale indoor environments,” _IEEE Transactions on Visualization and_
_Computer Graphics_, vol. 29, no. 11, pp. 4383–4393, 2023.

[11] V. Pasku, A. De Angelis, G. De Angelis, D. D. Arumugam, M. Dionigi,
P. Carbone, A. Moschitta, and D. S. Ricketts, “Magnetic field-based
positioning systems,” _IEEE Communications Surveys Tutorials_, vol. 19,
no. 3, pp. 2003–2017, 2017.

[12] P. Robertson, M. Frassl, M. Angermann, M. Doniec, B. J. Julian, M. Garcia Puyol, M. Khider, M. Lichtenstern, and L. Bruno, “Simultaneous
localization and mapping for pedestrians using distortions of the local
magnetic field intensity in large indoor environments,” in _International_
_Conference on Indoor Positioning and Indoor Navigation_, Montbeliard,
France, 2013, pp. 1–10.

[13] N. Pavlasek, C. C. Cossette, D. Roy-Guay, and J. R. Forbes, “Magnetic
navigation using attitude-invariant magnetic field information for loop
closure detection,” in _2023 IEEE/RSJ International Conference on_
_Intelligent Robots and Systems (IROS)_, Detroit, USA, 2023, pp. 5251–
5257.


9


Fig. 7. Illustration of the estimated and the true trajectory, as well as the magnetic field magnitude along the trajectory. The magnetic field magnitude plot
is created by the interpolated magnetic field measurements using a Gaussian process model.




[14] E. Dorveaux, T. Boudot, M. Hillion, and N. Petit, “Combining inertial
measurements and distributed magnetometry for motion estimation,” in
_Proc. 2011 American Control Conference_, San Francisco, CA, USA,
June 2011, pp. 4249–4256.

[15] E. Dorveaux and N. Petit, “Presentation of a magneto-inertial positioning
system: navigating through magnetic disturbances,” in _Int. Conf. on_
_Indoor Positioning and Indoor Navigation (IPIN)_, Guimaraes, Portugal,
Sep. 2011.

[16] C.-I. Chesneau, M. Hillion, and C. Prieur, “Motion estimation of a rigid
body with an EKF using magneto-inertial measurements,” in _Int. Conf._
_on Indoor Positioning and Indoor Navigation (IPIN)_, Alcal´a de Henares,
Spain, Oct. 2016, pp. 1–6.

[17] C.-I. Chesneau, M. Hillion, J.-F. Hullo, G. Thibault, and C. Prieur,
“Improving magneto-inertial attitude and position estimation by means
of a magnetic heading observer,” in _Proc. 2017 Int. Conf. on Indoor_
_Positioning and Indoor Navigation (IPIN)_, Sapporo, Japan, Sep. 2017,
pp. 1–8.

[18] M. Zmitri, H. Fourati, and C. Prieur, “Improving inertial velocity estimation through magnetic field gradient-based extended Kalman filter,”
in _Int. Conf. on Indoor Positioning and Indoor Navigation (IPIN)_, Pisa,
Italy, Sep. 2019, pp. 1–7.

[19] ——, “Magnetic Field Gradient-Based EKF for Velocity Estimation in



Indoor Navigation,” _Sensors_, vol. 20, no. 20, p. 5726, 2020.

[20] ——, “Inertial velocity estimation for indoor navigation through magnetic gradient-based EKF and LSTM learning model,” in _Proc. 2020_
_IEEE/RSJ Int. Conf. on Intelligent Robots and Systems (IROS)_, Las
Vegas, NV, USA, Oct. 2020, pp. 4545–4550.

[21] ——, “BiLSTM network-based extended kalman filter for magnetic field
gradient aided indoor navigation,” _IEEE Sensors Journal_, vol. 22, no. 6,
pp. 4781–4789, 2022.

[22] T. Zhang, L. Wei, J. Kuang, H. Tang, and X. Niu, “Mag-odo: Motion
speed estimation for indoor robots based on dual magnetometers,”
_Measurement_, vol. 222, p. 113688, 2023.

[23] I. Skog, G. Hendeby, and F. Gustafsson, “Magnetic odometry - a modelbased approach using a sensor array,” in _Int. Conf. on Information Fusion_
_(FUSION)_, Cambridge, United Kingdom, July 2018, pp. 794–798.

[24] C. Huang, G. Hendeby, and I. Skog, “A tightly-integrated magneticfield aided inertial navigation system,” in _Proc. 2022 25th Int. Conf. on_
_Information Fusion (FUSION)_, Link¨oping, Sweden, July 2022, pp. 1–8.

[25] J. Sol`a, “Quaternion kinematics for the error-state Kalman filter,”
_CoRR_ [, vol. abs/1711.02508, 2017. [Online]. Available: http://arxiv.org/](http://arxiv.org/abs/1711.02508)
[abs/1711.02508](http://arxiv.org/abs/1711.02508)

[26] J. D. Jackson, _Classical electrodynamics_, 3rd ed. New York, NY:
[Wiley, 1999. [Online]. Available: http://cdsweb.cern.ch/record/490457](http://cdsweb.cern.ch/record/490457)


10



TABLE II

S UMMARY OF RESULTS FROM EXPERIMENTAL EVALUATION


**LP-1** **LP-2** **LP-3** **NP-1** **NP-2** **NP-3** **NT-1** **NT-2**
Trajectory length ~~[*]~~ (m) 114.14 139.87 162.30 93.68 89.47 86.43 123.01 87.26
Trajectory duration [*] (s) 212 226 272 117 105 94 125 91
Stand-alone INS

RMS Horizontal Error (m) 45.18 140.04 384.41 43.92 28.14 36.0 130.27 36.91
Horizontal Error at the end (m) 75.48 346.84 1090.47 108.53 77.02 84.27 300.99 90.84
RMS Vertical Error (m) 87.13 78.45 110.54 6.48 10.77 5.08 5.72 10.76
Vertical Error at the end (m) 206.12 183.6 256.96 16.02 24.73 12.07 11.09 25.9
RMS Speed Error (m/s) 1.84 2.44 5.96 1.29 1.06 1.09 2.86 1.3
The method [19] with the **square** sensor configuration in Fig. 5
RMS Horizontal Error (m) 2.16 2.61 3.02 2.38 3.88 1.43 4.3 1.18
Horizontal Error at the end (m) 3.89 4.42 5.15 2.44 5.79 1.56 7.15 0.98
RMS Vertical Error (m) 0.96 1.49 2.4 1.09 2.03 0.74 12.24 6.74
Vertical Error at the end (m) 2.0 2.73 4.25 2.0 3.39 0.68 20.6 10.96
RMS Speed Error (m/s) 0.35 0.51 0.58 0.63 0.51 0.56 0.49 0.50
MAINS with the **square** sensor configuration in Fig. 5
RMS Horizontal Error (m) 0.66 1.29 1.6 1.88 1.62 1.89 2.91 0.81
Horizontal Error at the end (m) 1.25 1.82 2.55 3.22 2.65 2.89 4.51 1.04
RMS Vertical Error (m) 5.59 6.32 6.87 1.42 0.58 1.16 1.27 0.74
Vertical Error at the end(m) 9.61 10.54 11.76 2.04 1.21 1.16 2.22 1.42
RMS Speed Error (m/s) 0.12 0.17 0.14 0.24 0.17 0.29 0.22 0.20
MAINS with the **rectangular** sensor configuration in Fig. 5
RMS Horizontal Error (m) 0.77 0.84 1.15 2.65 1.24 2.32 0.83 1.73
Horizontal Error at the end (m) 0.61 1.65 2.49 4.21 1.49 3.72 1.82 2.38
RMS Vertical Error (m) 0.49 0.57 0.74 2.09 0.35 2.11 1.91 0.25
Vertical Error at the end (m) 0.56 0.99 1.22 2.78 0.89 2.52 3.16 0.64
RMS Speed Error (m/s) 0.10 0.11 0.12 0.20 0.24 0.24 0.19 0.17


- excluding the initial part of the trajectory where the position-aiding is turned on.




[27] S. Theodoridis, _Machine Learning: A Bayesian and Optimization Per-_
_spective_ . Elsevier Science, 2020.


**Chuan Huang** (Student member, IEEE) received
the B.Sc. from Beihang University in 2018 and the
M.Sc. degree from China Electronics Technology
Group Corporation Academy of Electronics and
Information Technology in 2021. He is now a Ph.D.
student at Link¨oping university, Sweden.
His main research interest is sensor fusion with
applications to magnetic field based positioning.



**Gustaf Hendeby** (Senior member, IEEE) received
the M.Sc. degree in applied physics and electrical
engineering in 2002 and the Ph.D. degree in automatic control in 2008, both from Linkoping University, Linkoping, Sweden. He is Associate Professor
and Docent in the division of Automatic Control,
Department of Electrical Engineering, Linkoping
University.
He worked as Senior Researcher at the German
Research Center for Artificial Intelligence (DFKI)
2009–2011, and Senior Scientist at Swedish Defense
Research Agency (FOI) and held an adjunct Associate Professor position at
Linkoping University 2011–2015. His main research interests are stochastic
signal processing and sensor fusion with applications to nonlinear problems,
target tracking, and simultaneous localization and mapping (SLAM), and is
the author of several published articles and conference papers in the area.
He has experience of both theoretical analysis as well as implementation
aspects. Dr. Hendeby is since 2018 an Associate Editor for IEEE Transactions
on Aerospace and Electronic Systems in the area of target tracking and
multisensor systems. In 2022 he served as general chair for the 25th IEEE
International Conference on Information Fusion (FUSION) in Linkoping,
Sweden.


11



**Hassen Fourati** (Senior member, IEEE) received
his bachelor of engineering degree in electrical
engineering at the National Engineering School of
Sfax (ENIS), Tunisia; master’s degree in automated
systems and control at the University of Claude
Bernard (UCBL), Lyon, France; and PhD degree in
automatic control at the University of Strasbourg,
France, in 2006, 2007, and 2010, respectively.
He is currently an associate professor of the
electrical engineering and computer science at the
University of Grenoble Alpes, Grenoble, France,
and a member of the Dynamics and Control of Networks Team (DANCE),
affiliated to the Pˆole Automatique et Diagnostic (PAD) of the GIPSA-Lab.
His research interests include nonlinear filtering, estimation and multisensor
fusion with applications in navigation, motion analysis, mobility and traffic
management. He has published several research papers in scientific journals,
international conferences, book chapters and books.


**Christophe Prieur** (Fellow member, IEEE) received
the M.Sc. degree in mathematics from the Ecole [´]
Normale Sup´erieure de Cachan, France, in 2000,
and the Ph.D. degree in applied mathematics from
Universit´e Paris-Sud, Orsay, France, in 2001.
He has been a Senior Researcher with the
French National Centre for Scientific Research,
Paris, France, since 2011. His current research interests include nonlinear control theory, hybrid systems,
and control of partial differential equations. Dr.
Prieur has been a member of the European Control
Association-Conference Editorial Board (EUCA-CEB) and the IEEE-Control
Systems Society (CSS) CEB. He was the Program Chair of the 9th IFAC
Symposium on Nonlinear Control Systems (NOLCOS 2013) and the 14th
European Control Conference (ECC 2015). He has been an Associate Editor
of the IEEE Transactions on Automatic Control, the European Journal of
Control, and the IEEE Transactions on Control Systems Technology. He is an
Associate Editor of the Evolution Equations and Control Theory (AIMS) and
the SIAM Journal on Control and Optimization. He is also a Senior Editor
of the IEEE Control Systems Letters and an Editor of the IMA Journal of
Mathematical Control and Information.


**Isaac Skog** (Senior Member, IEEE) received the
B.Sc. and M.Sc. degrees in electrical engineering
from the KTH Royal Institute of Technology, Stockholm, Sweden, in 2003 and 2005, respectively. In
2010, he received the Ph.D. degree in signal processing with a thesis on low-cost navigation systems.
In 2009, he spent 5 months with the Mobile
Multi-Sensor System Research Team, University of
Calgary, Calgary, AB, Canada, as a Visiting Scholar
and in 2011 he spent 4 months with the Indian
Institute of Science, Bangalore, India, as a Visiting
Scholar. Between 2010 and 2017, he was a Researcher with the KTH
Royal Institute of Technology. He is currently an Associate Professor with
Link¨oping University, Link¨oping, Sweden, and a Senior Researcher with
Swedish Defence Research Agency (FOI), Stockholm, Sweden. He is the
author and coauthor of more than 60 international journal and conference
publications. He was the recipient of the Best Survey Paper Award by the
IEEE Intelligent Transportation Systems Society in 2013.


